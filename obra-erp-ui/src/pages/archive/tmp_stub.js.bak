"use strict";
var __assign = (this && this.__assign) || function () {
    __assign = Object.assign || function(t) {
        for (var s, i = 1, n = arguments.length; i < n; i++) {
            s = arguments[i];
            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
                t[p] = s[p];
        }
        return t;
    };
    return __assign.apply(this, arguments);
};
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g = Object.create((typeof Iterator === "function" ? Iterator : Object).prototype);
    return g.next = verb(0), g["throw"] = verb(1), g["return"] = verb(2), typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (g && (g = 0, op[0] && (_ = 0)), _) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = PersonnelPage;
var jsx_runtime_1 = require("react/jsx-runtime");
var react_1 = require("react");
var api_1 = require("../lib/api");
var useDeleteAuth_1 = require("../hooks/useDeleteAuth");
var deleteAuth_1 = require("../lib/deleteAuth");
var ATTENDANCE_OPTIONS = ['PRESENT', 'TARDY', 'ABSENT', 'PERMISSION'];
var ADJUSTMENT_LABELS = {
    BONUS: 'Ingreso / bono',
    DEDUCTION: 'Descuento',
    ADVANCE: 'Adelanto de sueldo',
};
var ADJUSTMENT_OPTIONS = ['BONUS', 'DEDUCTION', 'ADVANCE'];
var ADJUSTMENT_SELECT_OPTIONS = ADJUSTMENT_OPTIONS.map(function (option) { return ({
    value: option,
    label: ADJUSTMENT_LABELS[option],
}); });
var PERIOD_STATUS_LABEL = {
    OPEN: 'Abierto',
    PROCESSED: 'Procesado',
    CLOSED: 'Cerrado',
};
var PENSION_SYSTEM_OPTIONS = [
    { value: 'ONP', label: 'ONP (13%)' },
    { value: 'AFP', label: 'AFP' },
    { value: 'SNP', label: 'SNP' },
    { value: 'NINGUNO', label: 'No aplica' },
    { value: 'EXONERADO', label: 'Exonerado' },
];
var YES_NO_OPTIONS = [
    { value: 'paid', label: 'Con goce' },
    { value: 'unpaid', label: 'Sin goce' },
];
var BANK_TYPE_OPTIONS = [
    { value: 'BCP', label: 'BCP' },
    { value: 'INTERBANK', label: 'Interbank' },
    { value: 'SCOTIABANK', label: 'Scotiabank' },
    { value: 'BANCO_NACION', label: 'Banco de la Nación' },
    { value: 'YAPE_PLIN', label: 'Yape/Plin' },
    { value: 'OTROS', label: 'Otros' },
];
var BANK_TYPE_LABELS = {
    BCP: 'BCP',
    INTERBANK: 'Interbank',
    SCOTIABANK: 'Scotiabank',
    BANCO_NACION: 'Banco de la Nación',
    YAPE_PLIN: 'Yape/Plin',
    OTROS: 'Otros',
};
var resolveBankLabel = function (value) {
    var _a;
    if (!value)
        return '—';
    var key = value;
    return (_a = BANK_TYPE_LABELS[key]) !== null && _a !== void 0 ? _a : value;
};
var EMPLOYEE_AREA_OPTIONS = [
    { value: 'OPERATIVE', label: 'Área operativa' },
    { value: 'ADMINISTRATIVE', label: 'Área administrativa' },
];
var EMPLOYEE_AREA_VALUES = ['OPERATIVE', 'ADMINISTRATIVE'];
var EMPLOYEE_AREA_LABELS = {
    OPERATIVE: 'Área operativa',
    ADMINISTRATIVE: 'Área administrativa',
};
var AREA_FILTER_BUTTONS = [
    { value: 'ALL', label: 'Todas' },
    { value: 'OPERATIVE', label: 'Operativa' },
    { value: 'ADMINISTRATIVE', label: 'Administrativa' },
];
var MONTH_NAMES = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre',
];
var MONTH_SELECT_OPTIONS = MONTH_NAMES.map(function (name, index) { return ({ value: index + 1, label: name }); });
var DEFAULT_ACCUMULATION_MONTHS = 3;
var MAX_ACCUMULATION_MONTHS = 6;
var PEN_NUMBER_FORMAT = new Intl.NumberFormat('es-PE', {
    useGrouping: true,
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
});
var createDeductionBreakdown = function () { return ({
    absence: 0,
    permission: 0,
    tardiness: 0,
    manual: 0,
}); };
var createExtrasTotals = function () { return ({
    advances: 0,
    holidays: 0,
    overtime: 0,
    bonuses: 0,
}); };
var createAreaExtrasMap = function () { return ({
    ALL: createExtrasTotals(),
    OPERATIVE: createExtrasTotals(),
    ADMINISTRATIVE: createExtrasTotals(),
}); };
var currency = function (value) { return "S/ ".concat(PEN_NUMBER_FORMAT.format(value !== null && value !== void 0 ? value : 0)); };
var fixed2 = function (value) { return PEN_NUMBER_FORMAT.format(value !== null && value !== void 0 ? value : 0); };
var HOURS_PER_DAY_DEFAULT = 8;
var resolveManualAdvances = function (entry) {
    var _a, _b, _c;
    var breakdownValue = (_b = (_a = entry.details) === null || _a === void 0 ? void 0 : _a.breakdown) === null || _b === void 0 ? void 0 : _b.manualAdvances;
    if (typeof breakdownValue === 'number' && Number.isFinite(breakdownValue)) {
        return Math.max(breakdownValue, 0);
    }
    if ((_c = entry.adjustments) === null || _c === void 0 ? void 0 : _c.length) {
        return entry.adjustments.reduce(function (acc, adjustment) {
            if (adjustment.type !== 'ADVANCE')
                return acc;
            var amount = Number(adjustment.amount);
            return acc + (Number.isFinite(amount) ? amount : 0);
        }, 0);
    }
    return 0;
};
var resolveDeductionComponents = function (entry) {
    var _a, _b, _c, _d, _e, _f, _g;
    var breakdown = ((_b = (_a = entry.details) === null || _a === void 0 ? void 0 : _a.breakdown) !== null && _b !== void 0 ? _b : {});
    var absence = Number((_c = breakdown === null || breakdown === void 0 ? void 0 : breakdown.absenceDeduction) !== null && _c !== void 0 ? _c : 0) || 0;
    var permission = Number((_d = breakdown === null || breakdown === void 0 ? void 0 : breakdown.permissionDeduction) !== null && _d !== void 0 ? _d : 0) || 0;
    var tardiness = Number((_e = breakdown === null || breakdown === void 0 ? void 0 : breakdown.tardinessDeduction) !== null && _e !== void 0 ? _e : 0) || 0;
    var manualAdvances = Number((_f = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualAdvances) !== null && _f !== void 0 ? _f : 0) || 0;
    var manualDeductionsRaw = Number((_g = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualDeductions) !== null && _g !== void 0 ? _g : 0) || 0;
    var manualDeductions = Math.max(0, manualDeductionsRaw - manualAdvances);
    return {
        absence: absence,
        permission: permission,
        tardiness: tardiness,
        manual: manualDeductions,
    };
};
var resolveActualDeductions = function (entry) {
    var components = resolveDeductionComponents(entry);
    return Math.max(components.absence + components.permission + components.tardiness + components.manual, 0);
};
var formatDeductionBreakdown = function (components) {
    var parts = [];
    if (components.absence > 0.005)
        parts.push("Faltas ".concat(currency(components.absence)));
    if (components.permission > 0.005)
        parts.push("Permisos sin goce ".concat(currency(components.permission)));
    if (components.tardiness > 0.005)
        parts.push("Tardanzas ".concat(currency(components.tardiness)));
    if (components.manual > 0.005)
        parts.push("Penalidades/ajustes ".concat(currency(components.manual)));
    return parts.length ? parts.join(' · ') : 'Sin descuentos registrados';
};
var buildDeductionBreakdownParts = function (components) {
    var parts = [];
    if (components.absence > 0.005)
        parts.push({ key: 'absence', label: 'Faltas', value: components.absence });
    if (components.permission > 0.005)
        parts.push({ key: 'permission', label: 'Permisos sin goce', value: components.permission });
    if (components.tardiness > 0.005)
        parts.push({ key: 'tardiness', label: 'Tardanzas', value: components.tardiness });
    if (components.manual > 0.005)
        parts.push({ key: 'manual', label: 'Penalidades/ajustes', value: components.manual });
    return parts;
};
var formatHoursQuantity = function (hours) {
    var rounded = Math.round(hours * 100) / 100;
    if (!Number.isFinite(rounded) || rounded <= 0)
        return '';
    var nearest = Math.round(rounded);
    var safe = Math.abs(rounded - nearest) < 1e-2 ? nearest : rounded;
    var text = Number.isInteger(safe) ? String(safe) : safe.toFixed(2);
    return "".concat(text, " ").concat(safe === 1 ? 'hora' : 'horas');
};
var normalizeQuantity = function (value, epsilon) {
    if (epsilon === void 0) { epsilon = 1e-2; }
    if (!Number.isFinite(value))
        return 0;
    if (Math.abs(value - Math.round(value)) < epsilon)
        return Math.round(value);
    return Math.abs(value) < epsilon ? 0 : value;
};
var formatIntegerDays = function (days) { return "".concat(days, " ").concat(days === 1 ? 'día' : 'días'); };
var formatDaysWithPartialHours = function (days, hours, hoursPerDay) {
    if (hoursPerDay === void 0) { hoursPerDay = HOURS_PER_DAY_DEFAULT; }
    var baseDays = Math.floor(days + 1e-6);
    var totalHours = Math.max(0, (days - baseDays) * hoursPerDay + hours);
    var roundedHours = Math.round(totalHours);
    if (roundedHours >= hoursPerDay) {
        return formatIntegerDays(baseDays + 1);
    }
    var dayLabel = formatIntegerDays(baseDays);
    if (roundedHours <= 0)
        return dayLabel;
    return "".concat(dayLabel, " y ").concat(formatHoursDetailed(roundedHours, true));
};
var formatHoursOrZero = function (hours) { return formatHoursQuantity(hours !== null && hours !== void 0 ? hours : 0) || '0 horas'; };
var formatHoursDetailed = function (hours, alwaysShow) {
    if (alwaysShow === void 0) { alwaysShow = false; }
    var rounded = Math.round(hours * 100) / 100;
    if (!alwaysShow && (!Number.isFinite(rounded) || rounded <= 0))
        return '';
    var safe = Number.isFinite(rounded) ? Math.max(rounded, 0) : 0;
    var isInteger = Math.abs(Math.round(safe) - safe) < 1e-6;
    var text = isInteger ? String(Math.round(safe)).padStart(2, '0') : safe.toFixed(2);
    return "".concat(text, " ").concat(safe === 1 ? 'hora' : 'horas');
};
var formatDaysWithHours = function (daysValue, hoursPerDay) {
    if (hoursPerDay === void 0) { hoursPerDay = HOURS_PER_DAY_DEFAULT; }
    var safeHoursPerDay = Number.isFinite(hoursPerDay) && hoursPerDay > 0 ? hoursPerDay : HOURS_PER_DAY_DEFAULT;
    var safeValue = Number.isFinite(daysValue) ? Math.max(daysValue, 0) : 0;
    var totalHours = safeValue * safeHoursPerDay;
    var wholeDays = Math.floor(totalHours / safeHoursPerDay + 1e-6);
    var remainingHours = totalHours - wholeDays * safeHoursPerDay;
    if (remainingHours < 1e-4)
        remainingHours = 0;
    if (remainingHours >= safeHoursPerDay - 1e-4) {
        wholeDays += 1;
        remainingHours = 0;
    }
    var hoursText = formatHoursQuantity(remainingHours);
    var dayLabel = wholeDays === 1 ? 'día' : 'días';
    if (wholeDays <= 0 && hoursText)
        return hoursText;
    if (!hoursText)
        return "".concat(wholeDays, " ").concat(dayLabel);
    return "".concat(wholeDays, " ").concat(dayLabel, " ").concat(hoursText);
};
var formatDaysAndExplicitHours = function (daysValue, hoursPerDay) {
    if (hoursPerDay === void 0) { hoursPerDay = HOURS_PER_DAY_DEFAULT; }
    var safeHoursPerDay = Number.isFinite(hoursPerDay) && hoursPerDay > 0 ? hoursPerDay : HOURS_PER_DAY_DEFAULT;
    var safeValue = Number.isFinite(daysValue) ? Math.max(daysValue, 0) : 0;
    var wholeDays = Math.floor(safeValue + 1e-6);
    var fractional = safeValue - wholeDays;
    var remainderHours = Math.round(fractional * safeHoursPerDay * 100) / 100;
    var displayDays = wholeDays;
    if (remainderHours >= safeHoursPerDay - 0.01) {
        displayDays += 1;
        remainderHours = 0;
    }
    var daysLabel = "".concat(displayDays, " ").concat(displayDays === 1 ? 'día' : 'días');
    if (remainderHours < 0.01)
        return daysLabel;
    return "".concat(daysLabel, " y ").concat(formatHoursDetailed(remainderHours, true));
};
var computePayrollDayInfo = function (entry, breakdown, attendance, options) {
    var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o;
    if (options === void 0) { options = {}; }
    var hoursPerDay = (function () {
        var dailyRate = breakdown === null || breakdown === void 0 ? void 0 : breakdown.dailyRate;
        var hourlyRate = breakdown === null || breakdown === void 0 ? void 0 : breakdown.hourlyRate;
        if (dailyRate && hourlyRate) {
            var ratio = dailyRate / hourlyRate;
            if (Number.isFinite(ratio) && ratio > 0) {
                return Math.min(Math.max(ratio, 4), 24);
            }
        }
        return HOURS_PER_DAY_DEFAULT;
    })();
    var baseDays = typeof options.baseDays === 'number' && options.baseDays > 0 ? options.baseDays : 30;
    var displayDays = (_b = (_a = attendance === null || attendance === void 0 ? void 0 : attendance.periodDays) !== null && _a !== void 0 ? _a : breakdown === null || breakdown === void 0 ? void 0 : breakdown.periodDays) !== null && _b !== void 0 ? _b : (typeof options.displayDaysFallback === 'number' && options.displayDaysFallback > 0
        ? options.displayDaysFallback
        : baseDays);
    var workedDays = (_d = (_c = entry.workedDays) !== null && _c !== void 0 ? _c : attendance === null || attendance === void 0 ? void 0 : attendance.workedDays) !== null && _d !== void 0 ? _d : 0;
    var absenceDays = (_f = (_e = entry.absenceDays) !== null && _e !== void 0 ? _e : attendance === null || attendance === void 0 ? void 0 : attendance.absenceDays) !== null && _f !== void 0 ? _f : 0;
    var tardinessMinutes = (_h = (_g = entry.tardinessMinutes) !== null && _g !== void 0 ? _g : attendance === null || attendance === void 0 ? void 0 : attendance.tardinessMinutes) !== null && _h !== void 0 ? _h : 0;
    var penaltyDays = (_j = attendance === null || attendance === void 0 ? void 0 : attendance.absencePenaltyDays) !== null && _j !== void 0 ? _j : 0;
    var permissionDaysRecorded = (_l = (_k = entry.permissionDays) !== null && _k !== void 0 ? _k : attendance === null || attendance === void 0 ? void 0 : attendance.permissionDays) !== null && _l !== void 0 ? _l : 0;
    var rawPermissionHours = (_o = (_m = entry.permissionHours) !== null && _m !== void 0 ? _m : attendance === null || attendance === void 0 ? void 0 : attendance.permissionHours) !== null && _o !== void 0 ? _o : 0;
    var permissionDaysForCalc = permissionDaysRecorded;
    var permissionHoursBalance = Math.max(rawPermissionHours, 0);
    var extraPermissionDays = Math.floor(permissionHoursBalance / hoursPerDay);
    permissionDaysForCalc += extraPermissionDays;
    permissionHoursBalance -= extraPermissionDays * hoursPerDay;
    var tardinessHours = tardinessMinutes / 60;
    var recordedEligibleDays = typeof options.eligibleDaysOverride === 'number'
        ? options.eligibleDaysOverride
        : typeof (attendance === null || attendance === void 0 ? void 0 : attendance.eligibleDays) === 'number'
            ? attendance.eligibleDays
            : typeof (breakdown === null || breakdown === void 0 ? void 0 : breakdown.eligibleDays) === 'number'
                ? breakdown.eligibleDays
                : undefined;
    var initialGapDays = typeof options.initialGapDays === 'number' && Number.isFinite(options.initialGapDays)
        ? Math.max(options.initialGapDays, 0)
        : 0;
    var deductionDays = absenceDays + permissionDaysForCalc + penaltyDays + initialGapDays;
    var deductionHours = permissionHoursBalance + tardinessHours;
    var netDaysFrom = function (total) {
        return Math.max(total - deductionDays - deductionHours / hoursPerDay, 0);
    };
    var netDays = netDaysFrom(baseDays);
    if (typeof recordedEligibleDays === 'number' && Number.isFinite(recordedEligibleDays)) {
        netDays = Math.min(recordedEligibleDays, netDays);
    }
    var netDaysDisplay = netDaysFrom(displayDays);
    var display = displayDays > 0
        ? "".concat(formatDaysWithHours(netDaysDisplay, hoursPerDay), " / ").concat(displayDays)
        : formatDaysWithHours(netDaysDisplay, hoursPerDay);
    var fallbackEligibleDays = typeof recordedEligibleDays === 'number' && Number.isFinite(recordedEligibleDays)
        ? Math.max(recordedEligibleDays, 0)
        : null;
    if ((!Number.isFinite(workedDays) || workedDays <= 0) && fallbackEligibleDays !== null) {
        workedDays = Math.max(fallbackEligibleDays - (absenceDays + permissionDaysForCalc + penaltyDays), 0);
    }
    return {
        baseDays: baseDays,
        displayDays: displayDays,
        hoursPerDay: hoursPerDay,
        netDays: netDays,
        netDaysDisplay: netDaysDisplay,
        display: display,
        permissionDaysRecorded: permissionDaysRecorded,
        rawPermissionHours: rawPermissionHours,
        tardinessMinutes: tardinessMinutes,
        absenceDays: absenceDays,
        workedDays: workedDays,
        penaltyDays: penaltyDays,
    };
};
var formatIsoDate = function (value) {
    if (!value)
        return '—';
    var date = new Date(value);
    if (Number.isNaN(date.getTime()))
        return '—';
    return date.toLocaleDateString('es-PE', { timeZone: 'UTC' });
};
var formatIsoDateShort = function (value) {
    if (!value)
        return '—';
    var date = new Date(value);
    if (Number.isNaN(date.getTime()))
        return '—';
    return date.toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: '2-digit', timeZone: 'UTC' });
};
var escapeHtml = function (value) {
    return value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
};
var formatDateParts = function (year, month, day) {
    return "".concat(year, "-").concat(String(month).padStart(2, '0'), "-").concat(String(day).padStart(2, '0'));
};
var toInputDate = function (date) {
    var year = date.getUTCFullYear();
    var month = date.getUTCMonth() + 1;
    var day = date.getUTCDate();
    return formatDateParts(year, month, day);
};
var todayString = function () { return toInputDate(new Date()); };
var monthKeyFromDate = function (date) {
    return "".concat(date.getFullYear(), "-").concat(String(date.getMonth() + 1).padStart(2, '0'));
};
var parseMonthKey = function (key) {
    var _a = key.split('-').map(Number), y = _a[0], m = _a[1];
    var now = new Date();
    var year = Number.isFinite(y) ? y : now.getFullYear();
    var month = Number.isFinite(m) ? Math.min(Math.max(m, 1), 12) : now.getMonth() + 1;
    var daysInMonth = new Date(year, month, 0).getDate();
    var start = formatDateParts(year, month, 1);
    var end = formatDateParts(year, month, daysInMonth);
    return {
        start: start,
        end: end,
        label: "".concat(MONTH_NAMES[month - 1], " ").concat(year),
    };
};
var MS_PER_DAY = 24 * 60 * 60 * 1000;
var parseDateParts = function (value) {
    if (!value)
        return null;
    var match = /^(\d{4})-(\d{2})-(\d{2})/.exec(value.trim());
    if (!match)
        return null;
    var yearStr = match[1], monthStr = match[2], dayStr = match[3];
    var year = Number(yearStr);
    var month = Number(monthStr);
    var day = Number(dayStr);
    if (!Number.isFinite(year) || !Number.isFinite(month) || !Number.isFinite(day))
        return null;
    return { year: year, month: month, day: day };
};
var countInclusiveDays = function (start, end) {
    var startParts = parseDateParts(start);
    var endParts = parseDateParts(end);
    if (!startParts || !endParts)
        return null;
    var startUtc = Date.UTC(startParts.year, startParts.month - 1, startParts.day);
    var endUtc = Date.UTC(endParts.year, endParts.month - 1, endParts.day);
    if (!Number.isFinite(startUtc) || !Number.isFinite(endUtc) || endUtc < startUtc)
        return null;
    return Math.floor((endUtc - startUtc) / MS_PER_DAY) + 1;
};
var getPeriodDayCount = function (period) {
    var configured = typeof (period === null || period === void 0 ? void 0 : period.workingDays) === 'number' && period.workingDays > 0
        ? Math.min(Math.max(Math.round(period.workingDays), 1), 30)
        : null;
    if (configured)
        return configured;
    var counted = countInclusiveDays(period === null || period === void 0 ? void 0 : period.startDate, period === null || period === void 0 ? void 0 : period.endDate);
    if (typeof counted === 'number' && counted > 0)
        return counted;
    return 30;
};
var getEntryEligibilityInfo = function (entry, period, attendance) {
    var _a, _b, _c, _d;
    var periodDayCount = getPeriodDayCount(period);
    var periodStartParts = parseDateParts(period === null || period === void 0 ? void 0 : period.startDate);
    var periodEndParts = parseDateParts(period === null || period === void 0 ? void 0 : period.endDate);
    if (!periodStartParts || !periodEndParts) {
        return { periodDayCount: periodDayCount, eligibleDays: periodDayCount, gapDays: 0 };
    }
    var periodStartUtc = Date.UTC(periodStartParts.year, periodStartParts.month - 1, periodStartParts.day);
    var periodEndUtc = Date.UTC(periodEndParts.year, periodEndParts.month - 1, periodEndParts.day);
    if (!Number.isFinite(periodStartUtc) || !Number.isFinite(periodEndUtc) || periodEndUtc < periodStartUtc) {
        return { periodDayCount: periodDayCount, eligibleDays: periodDayCount, gapDays: 0 };
    }
    var startRaw = (_d = (_c = (_a = attendance === null || attendance === void 0 ? void 0 : attendance.startDate) !== null && _a !== void 0 ? _a : (_b = entry.employee) === null || _b === void 0 ? void 0 : _b.startDate) !== null && _c !== void 0 ? _c : attendance === null || attendance === void 0 ? void 0 : attendance.periodStart) !== null && _d !== void 0 ? _d : null;
    var startParts = parseDateParts(startRaw);
    if (!startParts) {
        return { periodDayCount: periodDayCount, eligibleDays: periodDayCount, gapDays: 0 };
    }
    var entryStartUtc = Date.UTC(startParts.year, startParts.month - 1, startParts.day);
    if (!Number.isFinite(entryStartUtc) || entryStartUtc > periodEndUtc) {
        return { periodDayCount: periodDayCount, eligibleDays: 0, gapDays: periodDayCount };
    }
    var effectiveStart = Math.max(entryStartUtc, periodStartUtc);
    var eligibleDays = Math.max(Math.floor((periodEndUtc - effectiveStart) / MS_PER_DAY) + 1, 0);
    var gapDays = Math.max(periodDayCount - eligibleDays, 0);
    return { periodDayCount: periodDayCount, eligibleDays: eligibleDays, gapDays: gapDays };
};
var defaultEmployeeForm = function () { return ({
    firstName: '',
    lastName: '',
    documentNumber: '',
    position: '',
    baseSalary: '',
    bankType: 'BCP',
    accountNumber: '',
    cci: '',
    phone: '',
    pensionSystem: 'ONP',
    pensionRate: '0.13',
    healthRate: '0.09',
    startDate: todayString(),
    absenceSundayPenalty: false,
    area: 'OPERATIVE',
}); };
var defaultAttendanceForm = function (employees) { return ({
    employeeId: employees.length ? String(employees[0].id) : '',
    date: todayString(),
    status: 'PRESENT',
    minutesLate: '0',
    permissionHours: '0',
    extraHours: '0',
    permissionPaid: 'unpaid',
    holidayCount: '0',
    notes: '',
}); };
var defaultAdjustmentForm = function () { return ({
    entryId: '',
    type: 'BONUS',
    concept: '',
    amount: '',
}); };
var defaultPeriodForm = function () {
    var now = new Date();
    return {
        month: now.getMonth() + 1,
        year: now.getFullYear(),
        workingDays: 30,
        notes: '',
        fixedThirtyDays: true,
    };
};
var parseApiError = function (error, fallback) {
    var _a, _b;
    var defaultMessage = fallback;
    if (error instanceof Error) {
        var raw = (_b = (_a = error.message) === null || _a === void 0 ? void 0 : _a.trim()) !== null && _b !== void 0 ? _b : '';
        if (!raw)
            return defaultMessage;
        try {
            var parsed = JSON.parse(raw);
            if (typeof parsed === 'string')
                return parsed;
            if (parsed && typeof parsed === 'object') {
                if ('detail' in parsed && typeof parsed.detail === 'string') {
                    return parsed.detail;
                }
                if ('error' in parsed && typeof parsed.error === 'string') {
                    return parsed.error;
                }
                if ('message' in parsed && typeof parsed.message === 'string') {
                    return parsed.message;
                }
            }
        }
        catch (_c) {
            /* ignore JSON parse errors */
        }
        if (/duplicad/i.test(raw)) {
            return 'El código o documento ya existe.';
        }
        return raw;
    }
    if (typeof error === 'string' && error.trim()) {
        return error.trim();
    }
    return defaultMessage;
};
var prettyStatus = function (status) {
    switch (status) {
        case 'PRESENT': return 'Asistencia';
        case 'TARDY': return 'Tardanza';
        case 'ABSENT': return 'Falta';
        case 'PERMISSION': return 'Permiso';
        default: return status;
    }
};
var ATTENDANCE_STATUS_OPTIONS = ATTENDANCE_OPTIONS.map(function (option) { return ({ value: option, label: prettyStatus(option) }); });
var employeeName = function (employee) {
    return employee ? "".concat(employee.lastName, " ").concat(employee.firstName).trim() : '—';
};
function PersonnelPage() {
    var _this = this;
    var _a, _b, _c, _d;
    var _e = (0, react_1.useState)('employees'), tab = _e[0], setTab = _e[1];
    var _f = (0, react_1.useState)([]), obras = _f[0], setObras = _f[1];
    var _g = (0, react_1.useState)(''), obraId = _g[0], setObraId = _g[1];
    var _h = (0, react_1.useState)([]), employees = _h[0], setEmployees = _h[1];
    var _j = (0, react_1.useState)(false), employeesLoading = _j[0], setEmployeesLoading = _j[1];
    var _k = (0, react_1.useState)(null), employeeAlert = _k[0], setEmployeeAlert = _k[1];
    var _l = (0, react_1.useState)(function () { return defaultEmployeeForm(); }), employeeForm = _l[0], setEmployeeForm = _l[1];
    var deleteUnlocked = (0, useDeleteAuth_1.useDeleteAuth)();
    var _m = (0, react_1.useState)([]), attendance = _m[0], setAttendance = _m[1];
    var _o = (0, react_1.useState)(false), attendanceLoading = _o[0], setAttendanceLoading = _o[1];
    var _p = (0, react_1.useState)(null), attendanceAlert = _p[0], setAttendanceAlert = _p[1];
    var _q = (0, react_1.useState)(function () { return monthKeyFromDate(new Date()); }), attendanceMonth = _q[0], setAttendanceMonth = _q[1];
    var _r = (0, react_1.useState)(''), attendanceEmployeeFilter = _r[0], setAttendanceEmployeeFilter = _r[1];
    var _s = (0, react_1.useState)(function () { return defaultAttendanceForm([]); }), attendanceForm = _s[0], setAttendanceForm = _s[1];
    var _t = (0, react_1.useState)([]), periods = _t[0], setPeriods = _t[1];
    var _u = (0, react_1.useState)(false), periodsLoading = _u[0], setPeriodsLoading = _u[1];
    var _v = (0, react_1.useState)(null), periodAlert = _v[0], setPeriodAlert = _v[1];
    var _w = (0, react_1.useState)(function () { return defaultPeriodForm(); }), periodForm = _w[0], setPeriodForm = _w[1];
    var _x = (0, react_1.useState)(null), editingPeriodId = _x[0], setEditingPeriodId = _x[1];
    var _y = (0, react_1.useState)(null), selectedPeriodId = _y[0], setSelectedPeriodId = _y[1];
    var _z = (0, react_1.useState)(null), periodDetails = _z[0], setPeriodDetails = _z[1];
    var _0 = (0, react_1.useState)({}), periodDetailsCache = _0[0], setPeriodDetailsCache = _0[1];
    var _1 = (0, react_1.useState)(function () { return defaultAdjustmentForm(); }), entryForm = _1[0], setEntryForm = _1[1];
    var _2 = (0, react_1.useState)(null), entryAlert = _2[0], setEntryAlert = _2[1];
    var _3 = (0, react_1.useState)(false), accumulationLoading = _3[0], setAccumulationLoading = _3[1];
    var _4 = (0, react_1.useState)(''), periodEntrySearch = _4[0], setPeriodEntrySearch = _4[1];
    var _5 = (0, react_1.useState)(''), selectedEmployeeId = _5[0], setSelectedEmployeeId = _5[1];
    var _6 = (0, react_1.useState)('ALL'), employeeAreaFilter = _6[0], setEmployeeAreaFilter = _6[1];
    var _7 = (0, react_1.useState)('ALL'), reportAreaFilter = _7[0], setReportAreaFilter = _7[1];
    var _8 = (0, react_1.useState)('ALL'), bankFilter = _8[0], setBankFilter = _8[1];
    var _9 = (0, react_1.useState)(false), showAreaReport = _9[0], setShowAreaReport = _9[1];
    var _10 = (0, react_1.useState)(false), showBankReport = _10[0], setShowBankReport = _10[1];
    var _11 = (0, react_1.useState)([]), accumulationSelection = _11[0], setAccumulationSelection = _11[1];
    var _12 = (0, react_1.useState)({}), accumulationPayments = _12[0], setAccumulationPayments = _12[1];
    var _13 = (0, react_1.useState)({}), accumulationPaymentSaving = _13[0], setAccumulationPaymentSaving = _13[1];
    var _14 = (0, react_1.useState)(null), accumulationPaymentAlert = _14[0], setAccumulationPaymentAlert = _14[1];
    var _15 = (0, react_1.useState)('ALL'), accumulationPaymentFilter = _15[0], setAccumulationPaymentFilter = _15[1];
    var _16 = (0, react_1.useState)('ALL'), accumulationAccountFilter = _16[0], setAccumulationAccountFilter = _16[1];
    var filteredEmployees = (0, react_1.useMemo)(function () {
        return employeeAreaFilter === 'ALL'
            ? employees
            : employees.filter(function (emp) { var _a; return ((_a = emp.area) !== null && _a !== void 0 ? _a : 'OPERATIVE') === employeeAreaFilter; });
    }, [employeeAreaFilter, employees]);
    var employeesById = (0, react_1.useMemo)(function () {
        var result = new Map();
        employees.forEach(function (emp) { return result.set(emp.id, emp); });
        return result;
    }, [employees]);
    var periodEntries = (_a = periodDetails === null || periodDetails === void 0 ? void 0 : periodDetails.entries) !== null && _a !== void 0 ? _a : [];
    var filteredPeriodEntries = (0, react_1.useMemo)(function () {
        var term = periodEntrySearch.trim().toLowerCase();
        if (!term)
            return periodEntries;
        return periodEntries.filter(function (entry) { return employeeName(entry.employee).toLowerCase().includes(term); });
    }, [periodEntries, periodEntrySearch]);
    var refreshEmployees = (0, react_1.useCallback)(function (obra) { return __awaiter(_this, void 0, void 0, function () {
        var res, error_1;
        var _a;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    _b.trys.push([0, 2, 3, 4]);
                    setEmployeesLoading(true);
                    return [4 /*yield*/, api_1.personnelApi.employees.list({
                            obraId: typeof obra === 'number' ? obra : undefined,
                            active: true,
                        })];
                case 1:
                    res = _b.sent();
                    setEmployees((_a = res.items) !== null && _a !== void 0 ? _a : []);
                    return [3 /*break*/, 4];
                case 2:
                    error_1 = _b.sent();
                    setEmployeeAlert(parseApiError(error_1, 'No se pudo registrar al trabajador.'));
                    return [3 /*break*/, 4];
                case 3:
                    setEmployeesLoading(false);
                    return [7 /*endfinally*/];
                case 4: return [2 /*return*/];
            }
        });
    }); }, []);
    var refreshAttendance = (0, react_1.useCallback)(function (obra, employeeOverride) { return __awaiter(_this, void 0, void 0, function () {
        var range, overrideId, selectedEmployeeId_1, res, error_2;
        var _a;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    _b.trys.push([0, 2, 3, 4]);
                    setAttendanceLoading(true);
                    range = parseMonthKey(attendanceMonth);
                    overrideId = typeof employeeOverride === 'number' ? employeeOverride : undefined;
                    selectedEmployeeId_1 = overrideId !== null && overrideId !== void 0 ? overrideId : (typeof attendanceEmployeeFilter === 'number' ? attendanceEmployeeFilter : undefined);
                    return [4 /*yield*/, api_1.personnelApi.attendance.list({
                            obraId: typeof obra === 'number' ? obra : undefined,
                            employeeId: selectedEmployeeId_1,
                            from: range.start,
                            to: range.end,
                        })];
                case 1:
                    res = _b.sent();
                    setAttendance((_a = res.items) !== null && _a !== void 0 ? _a : []);
                    return [3 /*break*/, 4];
                case 2:
                    error_2 = _b.sent();
                    setAttendanceAlert(error_2 instanceof Error ? error_2.message : String(error_2));
                    return [3 /*break*/, 4];
                case 3:
                    setAttendanceLoading(false);
                    return [7 /*endfinally*/];
                case 4: return [2 /*return*/];
            }
        });
    }); }, [attendanceMonth, attendanceEmployeeFilter]);
    var handleEmployeeAreaFilterChange = (0, react_1.useCallback)(function (next) {
        setEmployeeAreaFilter(next);
    }, []);
    var refreshPeriods = (0, react_1.useCallback)(function (obra) { return __awaiter(_this, void 0, void 0, function () {
        var res, error_3;
        var _a;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    _b.trys.push([0, 2, 3, 4]);
                    setPeriodsLoading(true);
                    return [4 /*yield*/, api_1.personnelApi.periods.list({
                            obraId: typeof obra === 'number' ? obra : undefined,
                        })];
                case 1:
                    res = _b.sent();
                    setPeriods((_a = res.items) !== null && _a !== void 0 ? _a : []);
                    return [3 /*break*/, 4];
                case 2:
                    error_3 = _b.sent();
                    setPeriodAlert(error_3 instanceof Error ? error_3.message : String(error_3));
                    return [3 /*break*/, 4];
                case 3:
                    setPeriodsLoading(false);
                    return [7 /*endfinally*/];
                case 4: return [2 /*return*/];
            }
        });
    }); }, []);
    var loadPeriodDetails = (0, react_1.useCallback)(function (periodId) { return __awaiter(_this, void 0, void 0, function () {
        var period_1, error_4;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 2, , 3]);
                    if (periodDetailsCache[periodId]) {
                        setPeriodDetails(periodDetailsCache[periodId]);
                        return [2 /*return*/];
                    }
                    return [4 /*yield*/, api_1.personnelApi.periods.get(periodId)];
                case 1:
                    period_1 = _a.sent();
                    setPeriodDetails(period_1);
                    setPeriodDetailsCache(function (prev) {
                        var _a;
                        return (__assign(__assign({}, prev), (_a = {}, _a[periodId] = period_1, _a)));
                    });
                    setEntryForm(function () {
                        var next = defaultAdjustmentForm();
                        if (period_1.entries[0]) {
                            next.entryId = String(period_1.entries[0].id);
                        }
                        return next;
                    });
                    return [3 /*break*/, 3];
                case 2:
                    error_4 = _a.sent();
                    setPeriodAlert(error_4 instanceof Error ? error_4.message : String(error_4));
                    return [3 /*break*/, 3];
                case 3: return [2 /*return*/];
            }
        });
    }); }, [periodDetailsCache]);
    (0, react_1.useEffect)(function () {
        (function () { return __awaiter(_this, void 0, void 0, function () {
            var obrasList, error_5;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, , 3]);
                        return [4 /*yield*/, api_1.default.get('/obras')];
                    case 1:
                        obrasList = _a.sent();
                        setObras(obrasList);
                        if (!obraId && obrasList.length) {
                            setObraId(obrasList[0].id);
                        }
                        return [3 /*break*/, 3];
                    case 2:
                        error_5 = _a.sent();
                        setEmployeeAlert(parseApiError(error_5, 'No se pudo cargar la información inicial.'));
                        return [3 /*break*/, 3];
                    case 3: return [2 /*return*/];
                }
            });
        }); })();
    }, []); // eslint-disable-line react-hooks/exhaustive-deps
    (0, react_1.useEffect)(function () {
        var currentObra = typeof obraId === 'number' ? obraId : undefined;
        refreshEmployees(currentObra);
        refreshPeriods(currentObra);
    }, [obraId, refreshEmployees, refreshPeriods]);
    (0, react_1.useEffect)(function () {
        var currentObra = typeof obraId === 'number' ? obraId : undefined;
        refreshAttendance(currentObra);
    }, [obraId, attendanceMonth, refreshAttendance]);
    (0, react_1.useEffect)(function () {
        setAttendanceForm(defaultAttendanceForm(employees));
        if (selectedEmployeeId !== '' && !employees.some(function (emp) { return emp.id === selectedEmployeeId; })) {
            setSelectedEmployeeId('');
        }
    }, [employees, selectedEmployeeId]);
    var sortedPeriodsDesc = (0, react_1.useMemo)(function () {
        return __spreadArray([], periods, true).sort(function (a, b) {
            if (a.year !== b.year)
                return b.year - a.year;
            return b.month - a.month;
        });
    }, [periods]);
    var accumulationOptions = (0, react_1.useMemo)(function () { return sortedPeriodsDesc.slice(0, 12); }, [sortedPeriodsDesc]);
    var startOfCurrentMonth = (0, react_1.useMemo)(function () {
        var now = new Date();
        return new Date(now.getFullYear(), now.getMonth(), 1);
    }, []);
    var defaultPaidPeriods = (0, react_1.useMemo)(function () {
        var eligible = sortedPeriodsDesc.filter(function (period) {
            var periodDate = new Date(period.year, period.month - 1, 1);
            return periodDate < startOfCurrentMonth;
        });
        if (eligible.length) {
            return eligible.slice(0, DEFAULT_ACCUMULATION_MONTHS).map(function (period) { return period.id; });
        }
        return sortedPeriodsDesc.slice(0, DEFAULT_ACCUMULATION_MONTHS).map(function (period) { return period.id; });
    }, [sortedPeriodsDesc, startOfCurrentMonth]);
    (0, react_1.useEffect)(function () {
        if (!periods.length) {
            setAccumulationSelection([]);
            return;
        }
        setAccumulationSelection(function (prev) {
            if (prev.length) {
                var valid = prev.filter(function (id) { return periods.some(function (period) { return period.id === id; }); });
                if (valid.length === prev.length)
                    return prev;
                if (valid.length)
                    return valid;
            }
            var defaults = defaultPaidPeriods.length
                ? defaultPaidPeriods
                : sortedPeriodsDesc.slice(0, DEFAULT_ACCUMULATION_MONTHS).map(function (period) { return period.id; });
            return defaults;
        });
    }, [periods, sortedPeriodsDesc, defaultPaidPeriods]);
    var accumulationPeriods = (0, react_1.useMemo)(function () {
        if (!accumulationSelection.length)
            return [];
        var byId = new Map(periods.map(function (period) { return [period.id, period]; }));
        return accumulationSelection
            .map(function (id) { return byId.get(id); })
            .filter(function (period) { return Boolean(period); })
            .sort(function (a, b) {
            if (a.year !== b.year)
                return a.year - b.year;
            return a.month - b.month;
        });
    }, [accumulationSelection, periods]);
    (0, react_1.useEffect)(function () {
        if (!accumulationPeriods.length)
            return;
        var missing = accumulationPeriods.filter(function (period) { return !periodDetailsCache[period.id]; });
        if (!missing.length)
            return;
        var cancelled = false;
        setAccumulationLoading(true);
        (function () { return __awaiter(_this, void 0, void 0, function () {
            var fetched_1, error_6;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        _a.trys.push([0, 2, 3, 4]);
                        return [4 /*yield*/, Promise.all(missing.map(function (period) { return api_1.personnelApi.periods.get(period.id); }))];
                    case 1:
                        fetched_1 = _a.sent();
                        if (cancelled)
                            return [2 /*return*/];
                        setPeriodDetailsCache(function (prev) {
                            var next = __assign({}, prev);
                            fetched_1.forEach(function (period) {
                                next[period.id] = period;
                            });
                            return next;
                        });
                        return [3 /*break*/, 4];
                    case 2:
                        error_6 = _a.sent();
                        if (!cancelled) {
                            setEntryAlert(parseApiError(error_6, 'No se pudo calcular el acumulado histórico.'));
                        }
                        return [3 /*break*/, 4];
                    case 3:
                        if (!cancelled)
                            setAccumulationLoading(false);
                        return [7 /*endfinally*/];
                    case 4: return [2 /*return*/];
                }
            });
        }); })();
        return function () {
            cancelled = true;
        };
    }, [accumulationPeriods, periodDetailsCache]);
    var toggleAccumulationPeriod = (0, react_1.useCallback)(function (periodId) {
        setAccumulationSelection(function (prev) {
            var exists = prev.includes(periodId);
            if (exists)
                return prev.filter(function (id) { return id !== periodId; });
            if (prev.length >= MAX_ACCUMULATION_MONTHS) {
                setEntryAlert("Selecciona como m\u00E1ximo ".concat(MAX_ACCUMULATION_MONTHS, " periodos para el acumulado."));
                return prev;
            }
            return __spreadArray(__spreadArray([], prev, true), [periodId], false);
        });
    }, [setEntryAlert]);
    var handleSelectLatestPeriods = (0, react_1.useCallback)(function () {
        if (!sortedPeriodsDesc.length)
            return;
        var defaults = defaultPaidPeriods.length
            ? defaultPaidPeriods
            : sortedPeriodsDesc.slice(0, DEFAULT_ACCUMULATION_MONTHS).map(function (period) { return period.id; });
        setAccumulationSelection(defaults);
    }, [defaultPaidPeriods, sortedPeriodsDesc]);
    var refreshAccumulationPayments = (0, react_1.useCallback)(function () { return __awaiter(_this, void 0, void 0, function () {
        var response, map_1, error_7;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 2, , 3]);
                    return [4 /*yield*/, api_1.personnelApi.accumulationPayments.list()];
                case 1:
                    response = _a.sent();
                    map_1 = {};
                    response.items.forEach(function (item) {
                        map_1[item.employeeId] = item.paid;
                    });
                    setAccumulationPayments(map_1);
                    return [3 /*break*/, 3];
                case 2:
                    error_7 = _a.sent();
                    setAccumulationPaymentAlert(parseApiError(error_7, 'No se pudo cargar el estado de pago.'));
                    return [3 /*break*/, 3];
                case 3: return [2 /*return*/];
            }
        });
    }); }, []);
    (0, react_1.useEffect)(function () {
        refreshAccumulationPayments();
    }, [refreshAccumulationPayments]);
    var handleAccumulationPaymentChange = (0, react_1.useCallback)(function (employeeId, paid) { return __awaiter(_this, void 0, void 0, function () {
        var payload, password, response_1, error_8;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    setAccumulationPaymentAlert(null);
                    setAccumulationPaymentSaving(function (prev) {
                        var _a;
                        return (__assign(__assign({}, prev), (_a = {}, _a[employeeId] = true, _a)));
                    });
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 3, 4, 5]);
                    payload = { paid: paid };
                    if (!paid) {
                        password = (0, deleteAuth_1.getDeletePassword)();
                        if (!password) {
                            throw new Error('Desbloquea Seguridad para modificar pagos confirmados.');
                        }
                        payload.adminPassword = password;
                    }
                    return [4 /*yield*/, api_1.personnelApi.accumulationPayments.update(employeeId, payload)];
                case 2:
                    response_1 = _a.sent();
                    setAccumulationPayments(function (prev) {
                        var _a;
                        return (__assign(__assign({}, prev), (_a = {}, _a[employeeId] = response_1.paid, _a)));
                    });
                    return [3 /*break*/, 5];
                case 3:
                    error_8 = _a.sent();
                    setAccumulationPaymentAlert(parseApiError(error_8, 'No se pudo actualizar el estado de pago.'));
                    return [3 /*break*/, 5];
                case 4:
                    setAccumulationPaymentSaving(function (prev) {
                        var next = __assign({}, prev);
                        delete next[employeeId];
                        return next;
                    });
                    return [7 /*endfinally*/];
                case 5: return [2 /*return*/];
            }
        });
    }); }, []);
    var handleEmployeeFormChange = function (key, value) {
        setEmployeeForm(function (prev) {
            var _a;
            return (__assign(__assign({}, prev), (_a = {}, _a[key] = value, _a)));
        });
    };
    var handleCreateEmployee = function (event) { return __awaiter(_this, void 0, void 0, function () {
        var baseSalary, payload, error_9;
        var _a, _b;
        return __generator(this, function (_c) {
            switch (_c.label) {
                case 0:
                    event.preventDefault();
                    setEmployeeAlert(null);
                    baseSalary = Number(employeeForm.baseSalary);
                    if (!employeeForm.firstName.trim() || !employeeForm.lastName.trim()) {
                        setEmployeeAlert('Ingresa nombres y apellidos.');
                        return [2 /*return*/];
                    }
                    if (Number.isNaN(baseSalary) || baseSalary <= 0) {
                        setEmployeeAlert('El sueldo base debe ser un número mayor a 0.');
                        return [2 /*return*/];
                    }
                    payload = {
                        firstName: employeeForm.firstName.trim(),
                        lastName: employeeForm.lastName.trim(),
                        documentNumber: ((_a = employeeForm.documentNumber) === null || _a === void 0 ? void 0 : _a.trim()) || null,
                        position: ((_b = employeeForm.position) === null || _b === void 0 ? void 0 : _b.trim()) || null,
                        baseSalary: baseSalary,
                        bankType: employeeForm.bankType,
                        accountNumber: employeeForm.accountNumber.trim() || null,
                        cci: employeeForm.cci.trim() || null,
                        phone: employeeForm.phone.trim() || null,
                        pensionSystem: employeeForm.pensionSystem,
                        pensionRate: Number(employeeForm.pensionRate) || 0,
                        healthRate: Number(employeeForm.healthRate) || 0,
                        obraId: typeof obraId === 'number' ? obraId : null,
                        startDate: employeeForm.startDate || null,
                        absenceSundayPenalty: employeeForm.absenceSundayPenalty,
                        area: employeeForm.area,
                    };
                    _c.label = 1;
                case 1:
                    _c.trys.push([1, 6, , 7]);
                    if (!(typeof selectedEmployeeId === 'number')) return [3 /*break*/, 3];
                    return [4 /*yield*/, api_1.personnelApi.employees.update(selectedEmployeeId, payload)];
                case 2:
                    _c.sent();
                    setEmployeeAlert('Trabajador actualizado.');
                    return [3 /*break*/, 5];
                case 3: return [4 /*yield*/, api_1.personnelApi.employees.create(payload)];
                case 4:
                    _c.sent();
                    setEmployeeAlert('Trabajador registrado con éxito.');
                    _c.label = 5;
                case 5:
                    setEmployeeForm(defaultEmployeeForm());
                    setSelectedEmployeeId('');
                    refreshEmployees(obraId);
                    return [3 /*break*/, 7];
                case 6:
                    error_9 = _c.sent();
                    setEmployeeAlert(parseApiError(error_9, 'No se pudo registrar al trabajador.'));
                    return [3 /*break*/, 7];
                case 7: return [2 /*return*/];
            }
        });
    }); };
    var toggleEmployeeActive = function (employee) { return __awaiter(_this, void 0, void 0, function () {
        var error_10;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    _a.trys.push([0, 2, , 3]);
                    return [4 /*yield*/, api_1.personnelApi.employees.update(employee.id, { isActive: !employee.isActive })];
                case 1:
                    _a.sent();
                    refreshEmployees(obraId);
                    return [3 /*break*/, 3];
                case 2:
                    error_10 = _a.sent();
                    setEmployeeAlert(parseApiError(error_10, 'No se pudo actualizar el trabajador.'));
                    return [3 /*break*/, 3];
                case 3: return [2 /*return*/];
            }
        });
    }); };
    var handleDeleteEmployee = (0, react_1.useCallback)(function (targetId) { return __awaiter(_this, void 0, void 0, function () {
        var idToDelete, employee, fullName, confirmed, currentObra, error_11;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    if (!deleteUnlocked) {
                        window.alert('Desbloquea las eliminaciones en Seguridad antes de borrar trabajadores.');
                        return [2 /*return*/];
                    }
                    idToDelete = typeof targetId === 'number'
                        ? targetId
                        : typeof selectedEmployeeId === 'number'
                            ? selectedEmployeeId
                            : null;
                    if (!idToDelete) {
                        setEmployeeAlert('Selecciona un trabajador para eliminar.');
                        return [2 /*return*/];
                    }
                    employee = employees.find(function (emp) { return emp.id === idToDelete; });
                    fullName = employee ? employeeName(employee) : 'este trabajador';
                    confirmed = window.confirm("\u00BFEliminar definitivamente a ".concat(fullName, "? Esta acci\u00F3n no se puede deshacer."));
                    if (!confirmed)
                        return [2 /*return*/];
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 6, , 7]);
                    return [4 /*yield*/, api_1.personnelApi.employees.delete(idToDelete)];
                case 2:
                    _a.sent();
                    setEmployeeAlert('Trabajador eliminado.');
                    setSelectedEmployeeId('');
                    currentObra = typeof obraId === 'number' ? obraId : undefined;
                    return [4 /*yield*/, refreshEmployees(currentObra)];
                case 3:
                    _a.sent();
                    return [4 /*yield*/, refreshAttendance(currentObra)];
                case 4:
                    _a.sent();
                    return [4 /*yield*/, refreshPeriods(currentObra)];
                case 5:
                    _a.sent();
                    return [3 /*break*/, 7];
                case 6:
                    error_11 = _a.sent();
                    setEmployeeAlert(parseApiError(error_11, 'No se pudo eliminar al trabajador.'));
                    return [3 /*break*/, 7];
                case 7: return [2 /*return*/];
            }
        });
    }); }, [deleteUnlocked, selectedEmployeeId, employees, obraId, refreshEmployees, refreshAttendance, refreshPeriods]);
    var handleEditEmployee = (0, react_1.useCallback)(function (employeeId) { return __awaiter(_this, void 0, void 0, function () {
        var employee, data, _a, error_12;
        var _b, _c, _d, _e, _f, _g, _h, _j, _k;
        return __generator(this, function (_l) {
            switch (_l.label) {
                case 0:
                    _l.trys.push([0, 4, , 5]);
                    employee = employees.find(function (emp) { return emp.id === employeeId; });
                    if (!(employee !== null && employee !== void 0)) return [3 /*break*/, 1];
                    _a = employee;
                    return [3 /*break*/, 3];
                case 1: return [4 /*yield*/, api_1.personnelApi.employees.get(employeeId)];
                case 2:
                    _a = (_l.sent());
                    _l.label = 3;
                case 3:
                    data = _a;
                    setEmployeeForm({
                        firstName: data.firstName,
                        lastName: data.lastName,
                        documentNumber: (_b = data.documentNumber) !== null && _b !== void 0 ? _b : '',
                        position: (_c = data.position) !== null && _c !== void 0 ? _c : '',
                        baseSalary: String((_d = data.baseSalary) !== null && _d !== void 0 ? _d : ''),
                        bankType: (_e = data.bankType) !== null && _e !== void 0 ? _e : 'BCP',
                        accountNumber: (_f = data.accountNumber) !== null && _f !== void 0 ? _f : '',
                        cci: (_g = data.cci) !== null && _g !== void 0 ? _g : '',
                        phone: (_h = data.phone) !== null && _h !== void 0 ? _h : '',
                        pensionSystem: (_j = data.pensionSystem) !== null && _j !== void 0 ? _j : '',
                        pensionRate: data.pensionRate != null ? String(data.pensionRate) : '',
                        healthRate: data.healthRate != null ? String(data.healthRate) : '',
                        startDate: data.startDate ? data.startDate.slice(0, 10) : '',
                        absenceSundayPenalty: Boolean(data.absenceSundayPenalty),
                        area: (_k = data.area) !== null && _k !== void 0 ? _k : 'OPERATIVE',
                    });
                    setSelectedEmployeeId(employeeId);
                    setEmployeeAlert('Edita los campos y guarda para actualizar.');
                    return [3 /*break*/, 5];
                case 4:
                    error_12 = _l.sent();
                    setEmployeeAlert(parseApiError(error_12, 'No se pudo cargar los datos del trabajador.'));
                    return [3 /*break*/, 5];
                case 5: return [2 /*return*/];
            }
        });
    }); }, [employees]);
    var handleAttendanceFormChange = function (key, value) {
        setAttendanceForm(function (prev) {
            var _a;
            return (__assign(__assign({}, prev), (_a = {}, _a[key] = value, _a)));
        });
    };
    var handleSaveAttendance = function (event) { return __awaiter(_this, void 0, void 0, function () {
        var isPermissionPaid, holidayCount, payload, error_13;
        var _a;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    event.preventDefault();
                    setAttendanceAlert(null);
                    if (!attendanceForm.employeeId) {
                        setAttendanceAlert('Selecciona un trabajador.');
                        return [2 /*return*/];
                    }
                    isPermissionPaid = attendanceForm.permissionPaid === 'paid';
                    holidayCount = Math.max(0, Math.floor(Number(attendanceForm.holidayCount) || 0));
                    payload = {
                        employeeId: Number(attendanceForm.employeeId),
                        date: attendanceForm.date,
                        status: attendanceForm.status,
                        holidayCount: holidayCount,
                        holidayWorked: holidayCount > 0,
                    };
                    if (attendanceForm.status === 'TARDY') {
                        payload.minutesLate = Number(attendanceForm.minutesLate) || 0;
                    }
                    if (attendanceForm.status === 'PERMISSION') {
                        payload.permissionHours = Number(attendanceForm.permissionHours) || 0;
                        payload.permissionPaid = isPermissionPaid;
                    }
                    else if (isPermissionPaid) {
                        payload.permissionPaid = true;
                    }
                    payload.extraHours = Number(attendanceForm.extraHours) || 0;
                    payload.notes = ((_a = attendanceForm.notes) === null || _a === void 0 ? void 0 : _a.trim()) || null;
                    _b.label = 1;
                case 1:
                    _b.trys.push([1, 3, , 4]);
                    return [4 /*yield*/, api_1.personnelApi.attendance.upsert(payload)];
                case 2:
                    _b.sent();
                    refreshAttendance(obraId);
                    setAttendanceAlert('Asistencia registrada.');
                    return [3 /*break*/, 4];
                case 3:
                    error_13 = _b.sent();
                    setAttendanceAlert(error_13 instanceof Error ? error_13.message : String(error_13));
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    }); };
    var handleDeleteAttendance = function (record) { return __awaiter(_this, void 0, void 0, function () {
        var error_14;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    if (!deleteUnlocked) {
                        window.alert('Desbloquea las eliminaciones en Seguridad antes de borrar asistencia.');
                        return [2 /*return*/];
                    }
                    if (!window.confirm('¿Eliminar registro de asistencia?'))
                        return [2 /*return*/];
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 3, , 4]);
                    return [4 /*yield*/, api_1.personnelApi.attendance.remove(record.id)];
                case 2:
                    _a.sent();
                    refreshAttendance(obraId);
                    return [3 /*break*/, 4];
                case 3:
                    error_14 = _a.sent();
                    setAttendanceAlert(error_14 instanceof Error ? error_14.message : String(error_14));
                    return [3 /*break*/, 4];
                case 4: return [2 /*return*/];
            }
        });
    }); };
    var handleCancelPeriodEdit = function () {
        setEditingPeriodId(null);
        setPeriodForm(function () { return defaultPeriodForm(); });
    };
    var handleEditPeriod = function (period) {
        var _a;
        setEditingPeriodId(period.id);
        setPeriodAlert(null);
        setPeriodForm({
            month: period.month,
            year: period.year,
            workingDays: period.workingDays,
            notes: (_a = period.notes) !== null && _a !== void 0 ? _a : '',
            fixedThirtyDays: period.workingDays === 30,
        });
    };
    var handleSubmitPeriod = function (event) { return __awaiter(_this, void 0, void 0, function () {
        var payload, period, error_15;
        var _a;
        return __generator(this, function (_b) {
            switch (_b.label) {
                case 0:
                    event.preventDefault();
                    _b.label = 1;
                case 1:
                    _b.trys.push([1, 8, , 9]);
                    payload = {
                        month: Number(periodForm.month),
                        year: Number(periodForm.year),
                        workingDays: Number(periodForm.workingDays) || 30,
                        notes: ((_a = periodForm.notes) === null || _a === void 0 ? void 0 : _a.trim()) || null,
                        obraId: typeof obraId === 'number' ? obraId : null,
                    };
                    if (!editingPeriodId) return [3 /*break*/, 5];
                    return [4 /*yield*/, api_1.personnelApi.periods.update(editingPeriodId, payload)];
                case 2:
                    _b.sent();
                    setPeriodAlert('Periodo actualizado.');
                    refreshPeriods(obraId);
                    if (!(selectedPeriodId === editingPeriodId)) return [3 /*break*/, 4];
                    return [4 /*yield*/, loadPeriodDetails(editingPeriodId)];
                case 3:
                    _b.sent();
                    _b.label = 4;
                case 4:
                    handleCancelPeriodEdit();
                    return [3 /*break*/, 7];
                case 5: return [4 /*yield*/, api_1.personnelApi.periods.create(payload)];
                case 6:
                    period = _b.sent();
                    setPeriodAlert('Periodo creado.');
                    refreshPeriods(obraId);
                    setSelectedPeriodId(period.id);
                    loadPeriodDetails(period.id);
                    _b.label = 7;
                case 7: return [3 /*break*/, 9];
                case 8:
                    error_15 = _b.sent();
                    setPeriodAlert(error_15 instanceof Error ? error_15.message : String(error_15));
                    return [3 /*break*/, 9];
                case 9: return [2 /*return*/];
            }
        });
    }); };
    var handleSelectPeriod = function (id) { return __awaiter(_this, void 0, void 0, function () {
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    setSelectedPeriodId(id);
                    setPeriodDetails(null);
                    return [4 /*yield*/, loadPeriodDetails(id)];
                case 1:
                    _a.sent();
                    return [2 /*return*/];
            }
        });
    }); };
    (0, react_1.useEffect)(function () {
        setPeriodEntrySearch('');
    }, [selectedPeriodId]);
    var handleGeneratePeriod = function (period) { return __awaiter(_this, void 0, void 0, function () {
        var isClosed, confirmRecalc, error_16;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    isClosed = period.status === 'CLOSED';
                    if (isClosed) {
                        confirmRecalc = window.confirm('El periodo está cerrado. ¿Deseas recalcular la planilla? Esto reabrirá el periodo para seguir editando.');
                        if (!confirmRecalc)
                            return [2 /*return*/];
                    }
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 4, , 5]);
                    return [4 /*yield*/, api_1.personnelApi.periods.generate(period.id, isClosed)];
                case 2:
                    _a.sent();
                    setPeriodAlert('Planilla generada.');
                    return [4 /*yield*/, loadPeriodDetails(period.id)];
                case 3:
                    _a.sent();
                    refreshPeriods(obraId);
                    return [3 /*break*/, 5];
                case 4:
                    error_16 = _a.sent();
                    setPeriodAlert(error_16 instanceof Error ? error_16.message : String(error_16));
                    return [3 /*break*/, 5];
                case 5: return [2 /*return*/];
            }
        });
    }); };
    var handleClosePeriod = function (periodId) { return __awaiter(_this, void 0, void 0, function () {
        var error_17;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    if (!window.confirm('¿Cerrar periodo? No podrás editarlo luego.'))
                        return [2 /*return*/];
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 4, , 5]);
                    return [4 /*yield*/, api_1.personnelApi.periods.close(periodId)];
                case 2:
                    _a.sent();
                    setPeriodAlert('Periodo cerrado.');
                    refreshPeriods(obraId);
                    return [4 /*yield*/, loadPeriodDetails(periodId)];
                case 3:
                    _a.sent();
                    return [3 /*break*/, 5];
                case 4:
                    error_17 = _a.sent();
                    setPeriodAlert(error_17 instanceof Error ? error_17.message : String(error_17));
                    return [3 /*break*/, 5];
                case 5: return [2 /*return*/];
            }
        });
    }); };
    var handleAdjustmentFormChange = function (key, value) {
        setEntryForm(function (prev) {
            var _a;
            if (key === 'type') {
                var typedValue = value;
                var shouldPrefill = typedValue === 'ADVANCE' && (!prev.concept || prev.concept === 'Adelanto de sueldo');
                var shouldClear = typedValue !== 'ADVANCE' && prev.concept === 'Adelanto de sueldo';
                return __assign(__assign({}, prev), { type: typedValue, concept: shouldPrefill ? 'Adelanto de sueldo' : shouldClear ? '' : prev.concept });
            }
            return __assign(__assign({}, prev), (_a = {}, _a[key] = value, _a));
        });
    };
    var handleAddAdjustment = function (event) { return __awaiter(_this, void 0, void 0, function () {
        var amount, concept, payload, entryId, error_18;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    event.preventDefault();
                    if (!entryForm.entryId) {
                        setEntryAlert('Selecciona una boleta.');
                        return [2 /*return*/];
                    }
                    amount = Number(entryForm.amount);
                    if (!amount || amount <= 0) {
                        setEntryAlert('Ingresa un monto válido.');
                        return [2 /*return*/];
                    }
                    concept = entryForm.type === 'ADVANCE' && !entryForm.concept.trim()
                        ? 'Adelanto de sueldo'
                        : entryForm.concept.trim();
                    if (!concept) {
                        setEntryAlert('Ingresa un concepto.');
                        return [2 /*return*/];
                    }
                    payload = {
                        type: entryForm.type,
                        concept: concept,
                        amount: amount,
                    };
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 5, , 6]);
                    entryId = Number(entryForm.entryId);
                    return [4 /*yield*/, api_1.personnelApi.entries.addAdjustment(entryId, payload)];
                case 2:
                    _a.sent();
                    setEntryAlert('Ajuste aplicado.');
                    if (!selectedPeriodId) return [3 /*break*/, 4];
                    return [4 /*yield*/, loadPeriodDetails(selectedPeriodId)];
                case 3:
                    _a.sent();
                    _a.label = 4;
                case 4:
                    setEntryForm(function (form) { return (__assign(__assign({}, form), { concept: form.type === 'ADVANCE' ? 'Adelanto de sueldo' : '', amount: '' })); });
                    return [3 /*break*/, 6];
                case 5:
                    error_18 = _a.sent();
                    setEntryAlert(error_18 instanceof Error ? error_18.message : String(error_18));
                    return [3 /*break*/, 6];
                case 6: return [2 /*return*/];
            }
        });
    }); };
    var handleDeleteAdjustment = function (adjustment) { return __awaiter(_this, void 0, void 0, function () {
        var error_19;
        return __generator(this, function (_a) {
            switch (_a.label) {
                case 0:
                    if (!window.confirm('¿Quitar ajuste?'))
                        return [2 /*return*/];
                    _a.label = 1;
                case 1:
                    _a.trys.push([1, 5, , 6]);
                    return [4 /*yield*/, api_1.personnelApi.entries.deleteAdjustment(adjustment.id)];
                case 2:
                    _a.sent();
                    if (!selectedPeriodId) return [3 /*break*/, 4];
                    return [4 /*yield*/, loadPeriodDetails(selectedPeriodId)];
                case 3:
                    _a.sent();
                    _a.label = 4;
                case 4: return [3 /*break*/, 6];
                case 5:
                    error_19 = _a.sent();
                    setEntryAlert(error_19 instanceof Error ? error_19.message : String(error_19));
                    return [3 /*break*/, 6];
                case 6: return [2 /*return*/];
            }
        });
    }); };
    var buildPayrollSlip = (0, react_1.useCallback)(function (entry, period) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z, _0, _1, _2, _3, _4, _5, _6, _7, _8, _9, _10, _11, _12, _13;
        var breakdown = ((_b = (_a = entry.details) === null || _a === void 0 ? void 0 : _a.breakdown) !== null && _b !== void 0 ? _b : {});
        var attendance = ((_d = (_c = entry.details) === null || _c === void 0 ? void 0 : _c.attendance) !== null && _d !== void 0 ? _d : {});
        var eligibility = getEntryEligibilityInfo(entry, period, attendance);
        var dayInfo = computePayrollDayInfo(entry, breakdown, attendance, {
            baseDays: eligibility.periodDayCount,
            displayDaysFallback: eligibility.periodDayCount,
            initialGapDays: eligibility.gapDays,
            eligibleDaysOverride: eligibility.eligibleDays,
        });
        var monthlyBase = (_e = breakdown === null || breakdown === void 0 ? void 0 : breakdown.monthlyBase) !== null && _e !== void 0 ? _e : entry.baseSalary;
        var proratedBase = (_f = entry.baseSalary) !== null && _f !== void 0 ? _f : monthlyBase;
        var dailyRate = (_h = (_g = breakdown === null || breakdown === void 0 ? void 0 : breakdown.dailyRate) !== null && _g !== void 0 ? _g : entry.dailyRate) !== null && _h !== void 0 ? _h : null;
        var remuneration = proratedBase;
        var overtime = (_j = breakdown === null || breakdown === void 0 ? void 0 : breakdown.overtimeBonus) !== null && _j !== void 0 ? _j : 0;
        var feriados = (_l = (_k = breakdown === null || breakdown === void 0 ? void 0 : breakdown.holidayBonus) !== null && _k !== void 0 ? _k : entry.holidayBonus) !== null && _l !== void 0 ? _l : 0;
        var otherBonuses = (_m = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualBonuses) !== null && _m !== void 0 ? _m : 0;
        var weekendSundayDays = (_o = attendance === null || attendance === void 0 ? void 0 : attendance.weekendSundayDays) !== null && _o !== void 0 ? _o : 0;
        var weekendSundayBonus = (_p = breakdown === null || breakdown === void 0 ? void 0 : breakdown.weekendSundayBonus) !== null && _p !== void 0 ? _p : 0;
        var faltas = (_q = breakdown === null || breakdown === void 0 ? void 0 : breakdown.absenceDeduction) !== null && _q !== void 0 ? _q : 0;
        var permisos = (_r = breakdown === null || breakdown === void 0 ? void 0 : breakdown.permissionDeduction) !== null && _r !== void 0 ? _r : 0;
        var adelantos = (_s = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualAdvances) !== null && _s !== void 0 ? _s : 0;
        var otrasPenalidades = Math.max(0, ((_t = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualDeductions) !== null && _t !== void 0 ? _t : 0) - adelantos);
        var penalidades = otrasPenalidades + ((_u = breakdown === null || breakdown === void 0 ? void 0 : breakdown.tardinessDeduction) !== null && _u !== void 0 ? _u : 0);
        var pension = (_v = entry.pensionAmount) !== null && _v !== void 0 ? _v : 0;
        var essalud = (_w = entry.healthAmount) !== null && _w !== void 0 ? _w : 0;
        var startDate = (_z = (_x = attendance === null || attendance === void 0 ? void 0 : attendance.startDate) !== null && _x !== void 0 ? _x : (_y = entry.employee) === null || _y === void 0 ? void 0 : _y.startDate) !== null && _z !== void 0 ? _z : null;
        var holidayDays = (_1 = (_0 = entry.holidayDays) !== null && _0 !== void 0 ? _0 : attendance === null || attendance === void 0 ? void 0 : attendance.holidayDays) !== null && _1 !== void 0 ? _1 : 0;
        var hoursPerDay = dayInfo.hoursPerDay > 0 ? dayInfo.hoursPerDay : HOURS_PER_DAY_DEFAULT;
        var overtimeHours = (_2 = attendance === null || attendance === void 0 ? void 0 : attendance.overtimeHours) !== null && _2 !== void 0 ? _2 : 0;
        var overtimeHoursText = formatHoursOrZero(overtimeHours);
        var baseDayRate = dailyRate && dailyRate > 0
            ? dailyRate
            : monthlyBase && dayInfo.baseDays > 0
                ? monthlyBase / dayInfo.baseDays
                : null;
        var netBaseAmount = Math.max(remuneration - faltas - permisos - penalidades, 0);
        var paidDaysNet = baseDayRate && baseDayRate > 0 ? netBaseAmount / baseDayRate : (_3 = dayInfo.workedDays) !== null && _3 !== void 0 ? _3 : dayInfo.netDaysDisplay;
        var paidDaysLine = formatDaysWithPartialHours(paidDaysNet, 0, hoursPerDay);
        var generatedDaysText = paidDaysLine;
        var periodEligibleDays = (_4 = eligibility.eligibleDays) !== null && _4 !== void 0 ? _4 : dayInfo.baseDays;
        var periodBaseText = formatDaysAndExplicitHours(periodEligibleDays, hoursPerDay);
        var unpaidDifference = Math.max(periodEligibleDays - normalizeQuantity(paidDaysNet, 1e-2), 0);
        var permissionTotalDaysRaw = Math.max(dayInfo.permissionDaysRecorded + dayInfo.rawPermissionHours / hoursPerDay, 0);
        var permissionTotalDays = normalizeQuantity(permissionTotalDaysRaw, hoursPerDay * 0.05);
        var permitAbsenceAmount = faltas + permisos;
        var hasUnpaidPermission = normalizeQuantity(permitAbsenceAmount, 0.01) > 0;
        var derivedPermissionDays = normalizeQuantity(unpaidDifference, hoursPerDay * 0.05);
        var permissionDisplayDays = permissionTotalDays !== null && permissionTotalDays !== void 0 ? permissionTotalDays : 0;
        if (!hasUnpaidPermission) {
            permissionDisplayDays = 0;
        }
        else if (permissionDisplayDays > 0 && derivedPermissionDays > 0) {
            permissionDisplayDays = Math.min(permissionDisplayDays, derivedPermissionDays);
        }
        var permissionDisplay = formatDaysWithHours(permissionDisplayDays, hoursPerDay);
        var tardinessHoursText = formatHoursOrZero(dayInfo.tardinessMinutes / 60);
        var sundayPenaltyDays = (_5 = dayInfo.penaltyDays) !== null && _5 !== void 0 ? _5 : 0;
        var tardinessLabel = "".concat(dayInfo.tardinessMinutes, " min (").concat(tardinessHoursText, ")");
        var feriadoLabel = "".concat(holidayDays, " ").concat(holidayDays === 1 ? 'día' : 'días');
        var domingoLabel = "".concat(weekendSundayDays, " ").concat(weekendSundayDays === 1 ? 'día' : 'días');
        var pensionLabel = ((_6 = entry.employee) === null || _6 === void 0 ? void 0 : _6.pensionSystem)
            ? (_8 = (_7 = PENSION_SYSTEM_OPTIONS.find(function (opt) { var _a; return opt.value === ((_a = entry.employee) === null || _a === void 0 ? void 0 : _a.pensionSystem); })) === null || _7 === void 0 ? void 0 : _7.label) !== null && _8 !== void 0 ? _8 : 'Pensión'
            : 'Pensión';
        var absenceLabelBase = "".concat(dayInfo.absenceDays, " ").concat(dayInfo.absenceDays === 1 ? 'día' : 'días');
        var absenceLabelExtra = sundayPenaltyDays > 0 ? " \u00B7 +".concat(sundayPenaltyDays, " domingo").concat(sundayPenaltyDays === 1 ? '' : 's', " descontado").concat(sundayPenaltyDays === 1 ? '' : 's') : '';
        var permitAbsenceLabel = "".concat(absenceLabelBase).concat(absenceLabelExtra, " \u00B7 ").concat(hasUnpaidPermission ? permissionDisplay : formatDaysWithHours(0, hoursPerDay));
        var bonusSpecialsAmount = feriados + weekendSundayBonus + otherBonuses;
        var bonusSpecialsDetailParts = [];
        if (holidayDays > 0)
            bonusSpecialsDetailParts.push("Feriados ".concat(feriadoLabel));
        if (weekendSundayDays > 0)
            bonusSpecialsDetailParts.push("Domingos ".concat(domingoLabel));
        if (otherBonuses > 0)
            bonusSpecialsDetailParts.push('Bonos manuales');
        var bonusSpecialsDetail = bonusSpecialsDetailParts.length ? bonusSpecialsDetailParts.join(' · ') : '—';
        var contributionsAmount = pension + essalud;
        var contributionsDetailParts = [];
        if (pension > 0)
            contributionsDetailParts.push(pensionLabel);
        if (essalud > 0)
            contributionsDetailParts.push('Essalud');
        var contributionsDetail = contributionsDetailParts.length ? contributionsDetailParts.join(' + ') : '—';
        var earningsRows = [
            { label: 'Remuneración consolidada', detail: generatedDaysText, amount: remuneration, always: true },
            { label: 'Horas extras', detail: overtimeHoursText, amount: overtime },
            { label: 'Bonos especiales', detail: bonusSpecialsDetail, amount: bonusSpecialsAmount },
        ].filter(function (row) { var _a; return row.always || ((_a = row.amount) !== null && _a !== void 0 ? _a : 0) > 0; });
        var deductionsRows = [
            { label: 'Permisos / faltas', detail: permitAbsenceLabel, amount: permitAbsenceAmount, always: permitAbsenceAmount > 0 },
            { label: 'Adelantos', detail: 'Pagos adelantados registrados', amount: adelantos },
            { label: 'Penalidades / tardanzas', detail: 'Descuentos automáticos', amount: penalidades },
            { label: 'Aportes', detail: contributionsDetail, amount: contributionsAmount },
        ].filter(function (row) { var _a; return row.always || ((_a = row.amount) !== null && _a !== void 0 ? _a : 0) > 0; });
        var earningsRowsHtml = earningsRows
            .map(function (row) { return "\n        <tr>\n          <td>".concat(row.label, "</td>\n          <td class=\"detail\">").concat(row.detail, "</td>\n          <td class=\"amount\"><span>").concat(currency(row.amount), "</span></td>\n        </tr>"); })
            .join('') || '<tr><td colspan="3">Sin haberes adicionales.</td></tr>';
        var deductionsRowsHtml = deductionsRows
            .map(function (row) { return "\n        <tr>\n          <td>".concat(row.label, "</td>\n          <td class=\"detail\">").concat(row.detail, "</td>\n          <td class=\"amount\"><span>").concat(currency(row.amount), "</span></td>\n        </tr>"); })
            .join('') || '<tr><td colspan="3">Sin descuentos registrados.</td></tr>';
        var fullName = employeeName(entry.employee);
        var dni = (_10 = (_9 = entry.employee) === null || _9 === void 0 ? void 0 : _9.documentNumber) !== null && _10 !== void 0 ? _10 : '—';
        var cargo = (_12 = (_11 = entry.employee) === null || _11 === void 0 ? void 0 : _11.position) !== null && _12 !== void 0 ? _12 : '—';
        var ingreso = formatIsoDate(startDate !== null && startDate !== void 0 ? startDate : null);
        var mesLabel = "".concat(MONTH_NAMES[period.month - 1], " ").concat(period.year);
        var periodRange = "".concat(formatIsoDateShort(period.startDate), " - ").concat(formatIsoDateShort(period.endDate));
        var safeFullName = escapeHtml(fullName);
        var safeCargo = escapeHtml(cargo);
        var safeDni = escapeHtml(dni);
        var safeIngreso = escapeHtml(ingreso);
        var safeMes = escapeHtml(mesLabel);
        var safePeriodRange = escapeHtml(periodRange);
        return "\n<section class=\"payroll-slip\">\n  <div class=\"header\">\n    <div>\n      <div class=\"project\">PROYECTO</div>\n      <div class=\"project\">LA CARBONERA</div>\n    </div>\n    <div class=\"title\">BOLETA DE PAGO</div>\n    <div class=\"subtitle\">\n      <div><strong>CONSORCIO PAC\u00CDFICO</strong></div>\n      <div>RUC 20611482796</div>\n      <div>BOLETA N\u00B0 001</div>\n    </div>\n  </div>\n  <div class=\"box\">\n    <div><strong>DNI:</strong> ".concat(safeDni, "</div>\n    <div><strong>Cargo:</strong> ").concat(safeCargo, "</div>\n    <div><strong>Apellidos y Nombres:</strong> ").concat(safeFullName, "</div>\n    <div><strong>Fecha de ingreso:</strong> ").concat(safeIngreso, "</div>\n    <div><strong>Mes/A\u00F1o:</strong> ").concat(safeMes, "</div>\n    <div><strong>Periodo:</strong> ").concat(safePeriodRange, "</div>\n  </div>\n  <div class=\"box\">\n    <h4>Resumen del periodo</h4>\n    <div class=\"summary-grid\">\n      <div class=\"summary-item\">\n        <div class=\"label\">Sueldo mensual / Prorrateado</div>\n        <div class=\"value\">").concat(currency(monthlyBase), " \u00B7 ").concat(currency(proratedBase), "</div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">D\u00EDas trabajados y pagados</div>\n        <div class=\"value\">").concat(paidDaysLine, "</div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">Base del periodo</div>\n        <div class=\"value\">").concat(periodBaseText, "</div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">Fecha de ingreso</div>\n        <div class=\"value\">").concat(safeIngreso, "</div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">Permisos sin goce</div>\n        <div class=\"value\">").concat(permissionDisplay, "</div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">Faltas registradas</div>\n        <div class=\"value\">\n          ").concat(dayInfo.absenceDays, " ").concat(dayInfo.absenceDays === 1 ? 'día' : 'días', "\n          ").concat(sundayPenaltyDays > 0 ? "<span class=\"extra-note\">Dominicales descontados: ".concat(sundayPenaltyDays, "</span>") : '', "\n        </div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">Tardanzas</div>\n        <div class=\"value\">").concat(tardinessLabel, "</div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">Horas extras</div>\n        <div class=\"value\">").concat(overtimeHoursText, "</div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">Feriados trabajados</div>\n        <div class=\"value\">").concat(feriadoLabel, " \u00B7 Bono ").concat(currency((_13 = entry.holidayBonus) !== null && _13 !== void 0 ? _13 : 0), "</div>\n      </div>\n      <div class=\"summary-item\">\n        <div class=\"label\">Domingos trabajados</div>\n        <div class=\"value\">").concat(domingoLabel, "</div>\n      </div>\n    </div>\n  </div>\n  <div class=\"box\">\n    <div class=\"comp-columns\">\n      <div class=\"comp-box\">\n        <h4>Haberes percibidos</h4>\n        <table class=\"comp-table\">\n          <thead>\n            <tr>\n              <th>Concepto</th>\n              <th>Detalle</th>\n              <th>Monto</th>\n            </tr>\n          </thead>\n          <tbody>\n            ").concat(earningsRowsHtml, "\n          </tbody>\n        </table>\n      </div>\n      <div class=\"comp-box\">\n        <h4>Descuentos</h4>\n        <table class=\"comp-table\">\n          <thead>\n            <tr>\n              <th>Concepto</th>\n              <th>Detalle</th>\n              <th>Monto</th>\n            </tr>\n          </thead>\n          <tbody>\n            ").concat(deductionsRowsHtml, "\n          </tbody>\n        </table>\n      </div>\n    </div>\n  </div>\n  <div class=\"box net\">Neto a pagar: ").concat(currency(entry.netPay), "</div>\n  <div class=\"box signatures\">\n    <div class=\"sign\">\n      <div class=\"line\"></div>\n      <div>Firma del Empleador</div>\n    </div>\n    <div class=\"sign\">\n      <div class=\"line\"></div>\n      <div>Firma del Colaborador</div>\n    </div>\n  </div>\n</section>\n");
    }, []);
    var summarizeEntry = (0, react_1.useCallback)(function (entry) {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z, _0, _1, _2, _3;
        if (!periodDetails)
            return null;
        var breakdown = ((_b = (_a = entry.details) === null || _a === void 0 ? void 0 : _a.breakdown) !== null && _b !== void 0 ? _b : {});
        var attendance = ((_d = (_c = entry.details) === null || _c === void 0 ? void 0 : _c.attendance) !== null && _d !== void 0 ? _d : {});
        var monthlyBase = (_e = breakdown === null || breakdown === void 0 ? void 0 : breakdown.monthlyBase) !== null && _e !== void 0 ? _e : entry.baseSalary;
        var startDate = (_h = (_f = attendance === null || attendance === void 0 ? void 0 : attendance.startDate) !== null && _f !== void 0 ? _f : (_g = entry.employee) === null || _g === void 0 ? void 0 : _g.startDate) !== null && _h !== void 0 ? _h : null;
        var manualAdvances = (_j = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualAdvances) !== null && _j !== void 0 ? _j : 0;
        var manualDeductions = Math.max(0, ((_k = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualDeductions) !== null && _k !== void 0 ? _k : 0) - manualAdvances);
        var eligibility = getEntryEligibilityInfo(entry, periodDetails, attendance);
        var dayInfo = computePayrollDayInfo(entry, breakdown, attendance, {
            baseDays: eligibility.periodDayCount,
            displayDaysFallback: eligibility.periodDayCount,
            initialGapDays: eligibility.gapDays,
            eligibleDaysOverride: eligibility.eligibleDays,
        });
        var weekendSundayDays = (_l = attendance === null || attendance === void 0 ? void 0 : attendance.weekendSundayDays) !== null && _l !== void 0 ? _l : 0;
        var weekendSundayBonus = (_m = breakdown === null || breakdown === void 0 ? void 0 : breakdown.weekendSundayBonus) !== null && _m !== void 0 ? _m : 0;
        var faltas = (_o = breakdown === null || breakdown === void 0 ? void 0 : breakdown.absenceDeduction) !== null && _o !== void 0 ? _o : 0;
        var permisos = (_p = breakdown === null || breakdown === void 0 ? void 0 : breakdown.permissionDeduction) !== null && _p !== void 0 ? _p : 0;
        var actualDeductions = Math.max(faltas + permisos + ((_q = breakdown === null || breakdown === void 0 ? void 0 : breakdown.tardinessDeduction) !== null && _q !== void 0 ? _q : 0) + manualDeductions, 0);
        return {
            remuneration: (_s = (_r = entry.baseSalary) !== null && _r !== void 0 ? _r : monthlyBase) !== null && _s !== void 0 ? _s : 0,
            overtime: (_t = breakdown === null || breakdown === void 0 ? void 0 : breakdown.overtimeBonus) !== null && _t !== void 0 ? _t : 0,
            feriados: (_v = (_u = breakdown === null || breakdown === void 0 ? void 0 : breakdown.holidayBonus) !== null && _u !== void 0 ? _u : entry.holidayBonus) !== null && _v !== void 0 ? _v : 0,
            weekendSundayBonus: weekendSundayBonus,
            manualBonuses: (_w = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualBonuses) !== null && _w !== void 0 ? _w : 0,
            faltas: (_x = breakdown === null || breakdown === void 0 ? void 0 : breakdown.absenceDeduction) !== null && _x !== void 0 ? _x : 0,
            permisos: (_y = breakdown === null || breakdown === void 0 ? void 0 : breakdown.permissionDeduction) !== null && _y !== void 0 ? _y : 0,
            tardiness: (_z = breakdown === null || breakdown === void 0 ? void 0 : breakdown.tardinessDeduction) !== null && _z !== void 0 ? _z : 0,
            manualDeductions: manualDeductions,
            manualAdvances: manualAdvances,
            attendance: attendance,
            breakdown: breakdown,
            monthlyBase: monthlyBase,
            proratedBase: (_0 = entry.baseSalary) !== null && _0 !== void 0 ? _0 : monthlyBase,
            daysDisplay: dayInfo.display,
            startDate: startDate,
            workedDays: dayInfo.workedDays,
            absenceDays: dayInfo.absenceDays,
            tardinessMinutes: dayInfo.tardinessMinutes,
            permissionDaysRecorded: dayInfo.permissionDaysRecorded,
            permissionHours: dayInfo.rawPermissionHours,
            holidayDays: (_2 = (_1 = entry.holidayDays) !== null && _1 !== void 0 ? _1 : attendance === null || attendance === void 0 ? void 0 : attendance.holidayDays) !== null && _2 !== void 0 ? _2 : 0,
            holidayBonus: (_3 = entry.holidayBonus) !== null && _3 !== void 0 ? _3 : 0,
            weekendSundayDays: weekendSundayDays,
            actualDeductions: actualDeductions,
        };
    }, [periodDetails]);
    var renderPrintDocument = function (sections, title, options) {
        var _a;
        var safeTitle = escapeHtml(title);
        var orientation = (_a = options === null || options === void 0 ? void 0 : options.orientation) !== null && _a !== void 0 ? _a : 'portrait';
        var pageWidth = orientation === 'landscape' ? '277mm' : '190mm';
        var pages = sections.join('\n<div class="slip-gap"></div>\n');
        return "\n<!DOCTYPE html>\n<html lang=\"es\">\n<head>\n  <meta charset=\"utf-8\" />\n  <title>".concat(safeTitle, "</title>\n  <style>\n    @page { size: A4 ").concat(orientation, "; margin: 10mm; }\n    body { font-family: Arial, sans-serif; margin: 0 auto; width: ").concat(pageWidth, "; padding: 10mm 0; color: #1f2937; }\n    .slip-gap { height: 6mm; }\n    .payroll-slip { page-break-inside: avoid; border: 1px solid #cbd5e1; border-radius: 8px; padding: 16px; margin: 0 auto; max-width: 190mm; }\n    .area-report { page-break-inside: avoid; margin-bottom: 24px; }\n    .area-report h2 { font-size: 18px; margin: 0 0 12px 0; }\n    .area-report table { width: 100%; border-collapse: collapse; font-size: 11px; }\n    .area-report th, .area-report td { border: 1px solid #cbd5f5; padding: 6px; text-align: left; vertical-align: top; }\n    .area-report th { background-color: #e2e8f0; text-transform: uppercase; letter-spacing: 0.05em; font-size: 10px; }\n    .area-report .totals-row td { font-weight: 700; }\n    .header { display: flex; align-items: flex-start; justify-content: space-between; }\n    .project { font-size: 12px; font-weight: 600; }\n    .title { font-size: 20px; font-weight: 700; text-align: center; flex: 1; }\n    .subtitle { text-align: right; font-size: 12px; }\n    .box { border: 1px solid #cbd5e1; padding: 10px 12px; margin-top: 12px; border-radius: 6px; }\n    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 12px; }\n    .summary-grid.summary-compact { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }\n    .summary-item {\n      border: 1px solid #e2e8f0;\n      border-radius: 6px;\n      padding: 6px 8px;\n      background-color: #f8fafc;\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      justify-content: center;\n      text-align: center;\n      min-height: 48px;\n    }\n    .summary-item .label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.04em; color: #475569; margin-bottom: 2px; text-align: center; }\n    .summary-item .value { font-size: 13px; font-weight: 600; color: #0f172a; text-align: center; }\n    .summary-item .extra-note { display: block; font-size: 11px; color: #475569; font-weight: 400; margin-top: 2px; }\n    .columns { display: flex; gap: 24px; }\n    .col { flex: 1; }\n    .comp-columns { display: flex; flex-direction: column; gap: 16px; }\n    @media print {\n      .comp-columns { flex-direction: row; }\n    }\n    .comp-box { flex: 1; }\n    h4 { margin: 0 0 8px 0; font-size: 12px; text-transform: uppercase; }\n    ul { margin: 0; padding-left: 16px; font-size: 12px; }\n    .detail-list { list-style: none; padding-left: 0; margin: 0; font-size: 12px; }\n    .detail-list li { margin-bottom: 4px; }\n    .comp-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 8px; }\n    .comp-table th, .comp-table td { border: 1px solid #e2e8f0; padding: 6px 8px; }\n    .comp-table th { background-color: #f1f5f9; text-align: left; color: #475569; font-size: 11px; letter-spacing: 0.04em; }\n    .comp-table td.detail { font-size: 11px; color: #475569; }\n    .comp-table td.amount { text-align: right; font-weight: 600; color: #0f172a; white-space: nowrap; }\n    .comp-table td.amount span { display: inline-block; }\n    .net { font-size: 14px; font-weight: 700; text-align: center; margin-top: 12px; }\n    .signatures { display: flex; justify-content: space-between; margin-top: 24px; gap: 40px; }\n    .sign { flex: 1; text-align: center; font-size: 12px; }\n    .sign .line { border-top: 1px solid #1f2937; margin-bottom: 8px; margin-top: 32px; }\n    .page-break { page-break-after: always; }\n  </style>\n</head>\n<body>\n").concat(pages, "\n</body>\n</html>\n");
    };
    var openPrintDocument = function (html) {
        if (typeof window === 'undefined' || typeof document === 'undefined')
            return false;
        var iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        iframe.style.visibility = 'hidden';
        document.body.appendChild(iframe);
        var frameWindow = iframe.contentWindow;
        var frameDoc = frameWindow === null || frameWindow === void 0 ? void 0 : frameWindow.document;
        if (!frameWindow || !frameDoc) {
            document.body.removeChild(iframe);
            setEntryAlert('No se pudo preparar la impresión. Recarga la página e inténtalo de nuevo.');
            return false;
        }
        frameDoc.open();
        frameDoc.write(html);
        frameDoc.close();
        var cleanup = function () {
            setTimeout(function () {
                try {
                    document.body.removeChild(iframe);
                }
                catch (_a) {
                    /* ignore cleanup errors */
                }
            }, 100);
        };
        setTimeout(function () {
            try {
                frameWindow.focus();
                frameWindow.print();
            }
            catch (_a) {
                /* ignore print errors */
            }
            finally {
                cleanup();
            }
        }, 250);
        return true;
    };
    var handlePrintBoleta = (0, react_1.useCallback)(function (entry, period) {
        var slip = buildPayrollSlip(entry, period);
        var docTitle = "Boleta ".concat(MONTH_NAMES[period.month - 1], " ").concat(period.year);
        var html = renderPrintDocument([slip], docTitle);
        openPrintDocument(html);
    }, [buildPayrollSlip]);
    var handlePrintAllBoletas = (0, react_1.useCallback)(function () {
        if (!periodDetails || !periodDetails.entries.length) {
            setEntryAlert('No hay boletas para imprimir.');
            return;
        }
        var slips = periodDetails.entries.map(function (entry) { return buildPayrollSlip(entry, periodDetails); });
        var title = "Planillas ".concat(MONTH_NAMES[periodDetails.month - 1], " ").concat(periodDetails.year);
        var html = renderPrintDocument(slips, title);
        openPrintDocument(html);
    }, [buildPayrollSlip, periodDetails]);
    var attendanceRange = (0, react_1.useMemo)(function () { return parseMonthKey(attendanceMonth); }, [attendanceMonth]);
    var chosenEntry = (0, react_1.useMemo)(function () {
        var _a;
        if (!periodDetails || !entryForm.entryId)
            return null;
        return (_a = periodDetails.entries.find(function (e) { return e.id === Number(entryForm.entryId); })) !== null && _a !== void 0 ? _a : null;
    }, [periodDetails, entryForm.entryId]);
    var chosenEntrySummary = (0, react_1.useMemo)(function () {
        if (!chosenEntry)
            return null;
        return summarizeEntry(chosenEntry);
    }, [chosenEntry, summarizeEntry]);
    var periodTotals = (0, react_1.useMemo)(function () {
        if (!periodDetails)
            return null;
        return periodDetails.entries.reduce(function (acc, entry) {
            var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m;
            var breakdown = ((_b = (_a = entry.details) === null || _a === void 0 ? void 0 : _a.breakdown) !== null && _b !== void 0 ? _b : {});
            var monthlyBase = (_d = (_c = breakdown === null || breakdown === void 0 ? void 0 : breakdown.monthlyBase) !== null && _c !== void 0 ? _c : entry.baseSalary) !== null && _d !== void 0 ? _d : 0;
            var holidayBonus = Number((_f = (_e = breakdown === null || breakdown === void 0 ? void 0 : breakdown.holidayBonus) !== null && _e !== void 0 ? _e : entry.holidayBonus) !== null && _f !== void 0 ? _f : 0) || 0;
            var overtimeBonus = Number((_g = breakdown === null || breakdown === void 0 ? void 0 : breakdown.overtimeBonus) !== null && _g !== void 0 ? _g : 0) || 0;
            var sundayBonus = Number((_h = breakdown === null || breakdown === void 0 ? void 0 : breakdown.weekendSundayBonus) !== null && _h !== void 0 ? _h : 0) || 0;
            var manualBonuses = Number((_j = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualBonuses) !== null && _j !== void 0 ? _j : 0) || 0;
            var extrasAmount = overtimeBonus + sundayBonus;
            var manualAmount = manualBonuses;
            if (extrasAmount <= 0 && manualAmount <= 0) {
                var entryBonuses = Number((_k = entry.bonusesTotal) !== null && _k !== void 0 ? _k : 0) || 0;
                extrasAmount = Math.max(entryBonuses - holidayBonus, 0);
            }
            acc.base += Number(monthlyBase) || 0;
            acc.holidays += holidayBonus;
            acc.extras += extrasAmount;
            acc.bonuses += manualAmount;
            acc.deductions += resolveActualDeductions(entry);
            acc.pensions += Number((_l = entry.pensionAmount) !== null && _l !== void 0 ? _l : 0) || 0;
            acc.advances += resolveManualAdvances(entry);
            acc.net += Number((_m = entry.netPay) !== null && _m !== void 0 ? _m : 0) || 0;
            return acc;
        }, { base: 0, holidays: 0, extras: 0, bonuses: 0, deductions: 0, pensions: 0, advances: 0, net: 0 });
    }, [periodDetails]);
    var periodSummaryStats = (0, react_1.useMemo)(function () {
        return periodTotals
            ? [
                { key: 'base', label: 'Sueldos base', value: periodTotals.base, always: true },
                { key: 'holidays', label: 'Feriados', value: periodTotals.holidays },
                { key: 'extras', label: 'Horas extras', value: periodTotals.extras },
                { key: 'bonuses', label: 'Bonos', value: periodTotals.bonuses },
                { key: 'deductions', label: 'Descuentos', value: periodTotals.deductions },
                { key: 'pensions', label: 'Pensiones', value: periodTotals.pensions },
                { key: 'advances', label: 'Adelantos', value: periodTotals.advances },
                { key: 'net', label: 'Neto acumulado', value: periodTotals.net, always: true },
            ].filter(function (stat) { return stat.always || Math.abs(stat.value) > 0.005; })
            : [];
    }, [periodTotals]);
    var areaReportRows = (0, react_1.useMemo)(function () {
        if (!periodDetails)
            return [];
        return periodDetails.entries
            .filter(function (entry) { var _a, _b; return reportAreaFilter === 'ALL' ? true : ((_b = (_a = entry.employee) === null || _a === void 0 ? void 0 : _a.area) !== null && _b !== void 0 ? _b : 'OPERATIVE') === reportAreaFilter; })
            .map(function (entry) {
            var summary = summarizeEntry(entry);
            return summary ? { entry: entry, summary: summary } : null;
        })
            .filter(function (row) { return row !== null; });
    }, [periodDetails, reportAreaFilter, summarizeEntry]);
    var areaReportNetTotal = (0, react_1.useMemo)(function () { return areaReportRows.reduce(function (acc, row) { var _a; return acc + (Number((_a = row.entry.netPay) !== null && _a !== void 0 ? _a : 0) || 0); }, 0); }, [areaReportRows]);
    var accountsRows = (0, react_1.useMemo)(function () {
        if (!periodDetails)
            return [];
        return periodDetails.entries.map(function (entry) {
            var _a, _b, _c, _d, _e, _f, _g, _h;
            var resolvedEmployee = (_a = employeesById.get(entry.employeeId)) !== null && _a !== void 0 ? _a : entry.employee;
            var accountNumber = (_c = (_b = resolvedEmployee === null || resolvedEmployee === void 0 ? void 0 : resolvedEmployee.accountNumber) === null || _b === void 0 ? void 0 : _b.trim()) !== null && _c !== void 0 ? _c : '';
            var cci = (_e = (_d = resolvedEmployee === null || resolvedEmployee === void 0 ? void 0 : resolvedEmployee.cci) === null || _d === void 0 ? void 0 : _d.trim()) !== null && _e !== void 0 ? _e : '';
            var yapePlin = (_g = (_f = resolvedEmployee === null || resolvedEmployee === void 0 ? void 0 : resolvedEmployee.phone) === null || _f === void 0 ? void 0 : _f.trim()) !== null && _g !== void 0 ? _g : '';
            return {
                worker: employeeName(resolvedEmployee),
                bank: BANK_TYPE_LABELS[(_h = resolvedEmployee === null || resolvedEmployee === void 0 ? void 0 : resolvedEmployee.bankType) !== null && _h !== void 0 ? _h : 'BCP'],
                account: accountNumber || '—',
                cci: cci || '—',
                yapePlin: yapePlin || '—',
                hasAccount: Boolean(accountNumber) || Boolean(cci) || Boolean(yapePlin),
            };
        });
    }, [employeesById, periodDetails]);
    var accumulationSummary = (0, react_1.useMemo)(function () {
        if (!accumulationPeriods.length) {
            return {
                ready: true,
                months: [],
                rows: [],
                monthTotals: [],
                monthTotalsPaid: [],
                monthTotalsDeductions: [],
                monthDeductionBreakdown: [],
                totalDeductionBreakdown: createDeductionBreakdown(),
                monthAdvances: [],
                monthHolidays: [],
                monthBonuses: [],
                monthOvertime: [],
                total: 0,
                totalPaid: 0,
                totalDeductions: 0,
                totalAdvances: 0,
                totalHolidays: 0,
                totalBonuses: 0,
                totalOvertime: 0,
                areaExtras: createAreaExtrasMap(),
            };
        }
        var months = accumulationPeriods.map(function (period) { return ({
            id: period.id,
            label: "".concat(MONTH_NAMES[period.month - 1], " ").concat(period.year),
        }); });
        var ready = accumulationPeriods.every(function (period) { return Boolean(periodDetailsCache[period.id]); });
        if (!ready) {
            return {
                ready: false,
                months: months,
                rows: [],
                monthTotals: [],
                monthTotalsPaid: [],
                monthTotalsDeductions: [],
                monthDeductionBreakdown: [],
                totalDeductionBreakdown: createDeductionBreakdown(),
                monthAdvances: [],
                monthHolidays: [],
                monthBonuses: [],
                monthOvertime: [],
                total: 0,
                totalPaid: 0,
                totalDeductions: 0,
                totalAdvances: 0,
                totalHolidays: 0,
                totalBonuses: 0,
                totalOvertime: 0,
                areaExtras: createAreaExtrasMap(),
            };
        }
        var areaExtras = createAreaExtrasMap();
        var rowsMap = new Map();
        accumulationPeriods.forEach(function (period, periodIndex) {
            var details = periodDetailsCache[period.id];
            if (!details)
                return;
            details.entries.forEach(function (entry) {
                var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k, _l, _m, _o, _p, _q, _r, _s, _t, _u, _v, _w, _x, _y, _z, _0, _1, _2;
                var employeeRef = (_a = employeesById.get(entry.employeeId)) !== null && _a !== void 0 ? _a : entry.employee;
                var area = ((_d = (_b = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.area) !== null && _b !== void 0 ? _b : (_c = entry.employee) === null || _c === void 0 ? void 0 : _c.area) !== null && _d !== void 0 ? _d : 'OPERATIVE');
                var net = Number((_e = entry.netPay) !== null && _e !== void 0 ? _e : 0) || 0;
                if (!rowsMap.has(entry.employeeId)) {
                    var accountNumber_1 = ((_f = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.accountNumber) === null || _f === void 0 ? void 0 : _f.trim()) || ((_h = (_g = entry.employee) === null || _g === void 0 ? void 0 : _g.accountNumber) === null || _h === void 0 ? void 0 : _h.trim()) || '';
                    var cci_1 = ((_j = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.cci) === null || _j === void 0 ? void 0 : _j.trim()) || ((_l = (_k = entry.employee) === null || _k === void 0 ? void 0 : _k.cci) === null || _l === void 0 ? void 0 : _l.trim()) || '';
                    var yapePlin_1 = ((_m = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.phone) === null || _m === void 0 ? void 0 : _m.trim()) || ((_p = (_o = entry.employee) === null || _o === void 0 ? void 0 : _o.phone) === null || _p === void 0 ? void 0 : _p.trim()) || '';
                    var bankLabel_1 = resolveBankLabel(((_q = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.bankType) !== null && _q !== void 0 ? _q : (_r = entry.employee) === null || _r === void 0 ? void 0 : _r.bankType));
                    rowsMap.set(entry.employeeId, {
                        employeeId: entry.employeeId,
                        employee: employeeRef,
                        area: area,
                        perMonth: Array(accumulationPeriods.length).fill(0),
                        perMonthPaid: Array(accumulationPeriods.length).fill(0),
                        perMonthDeductions: Array(accumulationPeriods.length).fill(0),
                        total: 0,
                        totalPaid: 0,
                        totalDeductions: 0,
                        account: accountNumber_1 || '—',
                        cci: cci_1 || '—',
                        yapePlin: yapePlin_1 || '—',
                        bank: bankLabel_1,
                    });
                }
                var row = rowsMap.get(entry.employeeId);
                var manualAdvances = resolveManualAdvances(entry);
                var paidAmount = net + manualAdvances;
                var deductionsAmount = resolveActualDeductions(entry);
                row.perMonth[periodIndex] += net;
                row.perMonthPaid[periodIndex] += paidAmount;
                row.perMonthDeductions[periodIndex] += deductionsAmount;
                row.total += net;
                row.totalPaid += paidAmount;
                row.totalDeductions += deductionsAmount;
                if (!row.employee && employeeRef)
                    row.employee = employeeRef;
                row.area = area;
                var accountNumber = ((_s = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.accountNumber) === null || _s === void 0 ? void 0 : _s.trim()) || ((_u = (_t = entry.employee) === null || _t === void 0 ? void 0 : _t.accountNumber) === null || _u === void 0 ? void 0 : _u.trim()) || '';
                var cci = ((_v = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.cci) === null || _v === void 0 ? void 0 : _v.trim()) || ((_x = (_w = entry.employee) === null || _w === void 0 ? void 0 : _w.cci) === null || _x === void 0 ? void 0 : _x.trim()) || '';
                var yapePlin = ((_y = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.phone) === null || _y === void 0 ? void 0 : _y.trim()) || ((_0 = (_z = entry.employee) === null || _z === void 0 ? void 0 : _z.phone) === null || _0 === void 0 ? void 0 : _0.trim()) || '';
                var bankLabel = resolveBankLabel(((_1 = employeeRef === null || employeeRef === void 0 ? void 0 : employeeRef.bankType) !== null && _1 !== void 0 ? _1 : (_2 = entry.employee) === null || _2 === void 0 ? void 0 : _2.bankType));
                if ((!row.account || row.account === '—') && accountNumber)
                    row.account = accountNumber;
                if ((!row.cci || row.cci === '—') && cci)
                    row.cci = cci;
                if ((!row.yapePlin || row.yapePlin === '—') && yapePlin)
                    row.yapePlin = yapePlin;
                if ((!row.bank || row.bank === '—') && bankLabel !== '—')
                    row.bank = bankLabel;
            });
        });
        var rows = Array.from(rowsMap.values()).sort(function (a, b) {
            return employeeName(a.employee).localeCompare(employeeName(b.employee));
        });
        var monthTotals = Array(accumulationPeriods.length).fill(0);
        var monthTotalsPaid = Array(accumulationPeriods.length).fill(0);
        var monthTotalsDeductions = Array(accumulationPeriods.length).fill(0);
        var monthDeductionBreakdown = Array.from({ length: accumulationPeriods.length }, function () { return createDeductionBreakdown(); });
        var monthAdvances = Array(accumulationPeriods.length).fill(0);
        var monthHolidays = Array(accumulationPeriods.length).fill(0);
        var monthBonuses = Array(accumulationPeriods.length).fill(0);
        var monthOvertime = Array(accumulationPeriods.length).fill(0);
        rows.forEach(function (row) {
            row.perMonth.forEach(function (value, index) {
                monthTotals[index] += value;
            });
            row.perMonthPaid.forEach(function (value, index) {
                monthTotalsPaid[index] += value;
            });
            row.perMonthDeductions.forEach(function (value, index) {
                monthTotalsDeductions[index] += value;
            });
        });
        accumulationPeriods.forEach(function (period, index) {
            var details = periodDetailsCache[period.id];
            if (!details)
                return;
            var bucket = monthDeductionBreakdown[index];
            details.entries.forEach(function (entry) {
                var _a, _b, _c, _d, _e, _f, _g, _h, _j, _k;
                var breakdown = ((_b = (_a = entry.details) === null || _a === void 0 ? void 0 : _a.breakdown) !== null && _b !== void 0 ? _b : {});
                var holidayBonus = Number((_c = entry.holidayBonus) !== null && _c !== void 0 ? _c : 0) || 0;
                var weekendSundayBonus = Number((_d = breakdown === null || breakdown === void 0 ? void 0 : breakdown.weekendSundayBonus) !== null && _d !== void 0 ? _d : 0) || 0;
                var manualBonuses = Number((_e = breakdown === null || breakdown === void 0 ? void 0 : breakdown.manualBonuses) !== null && _e !== void 0 ? _e : 0) || 0;
                var overtimeBonus = Number((_f = breakdown === null || breakdown === void 0 ? void 0 : breakdown.overtimeBonus) !== null && _f !== void 0 ? _f : 0) || 0;
                var components = resolveDeductionComponents(entry);
                bucket.absence += components.absence;
                bucket.permission += components.permission;
                bucket.tardiness += components.tardiness;
                bucket.manual += components.manual;
                var advancesValue = resolveManualAdvances(entry);
                monthAdvances[index] += advancesValue;
                monthHolidays[index] += holidayBonus + weekendSundayBonus;
                monthBonuses[index] += manualBonuses;
                monthOvertime[index] += overtimeBonus;
                var entryEmployee = (_g = employeesById.get(entry.employeeId)) !== null && _g !== void 0 ? _g : entry.employee;
                var entryArea = ((_k = (_h = entryEmployee === null || entryEmployee === void 0 ? void 0 : entryEmployee.area) !== null && _h !== void 0 ? _h : (_j = entry.employee) === null || _j === void 0 ? void 0 : _j.area) !== null && _k !== void 0 ? _k : 'OPERATIVE');
                var targets = [areaExtras.ALL, areaExtras[entryArea]];
                targets.forEach(function (target) {
                    target.advances += advancesValue;
                    target.holidays += holidayBonus + weekendSundayBonus;
                    target.overtime += overtimeBonus;
                    target.bonuses += manualBonuses;
                });
            });
        });
        var total = rows.reduce(function (acc, row) { return acc + row.total; }, 0);
        var totalPaid = rows.reduce(function (acc, row) { return acc + row.totalPaid; }, 0);
        var totalDeductions = rows.reduce(function (acc, row) { return acc + row.totalDeductions; }, 0);
        var totalDeductionBreakdown = monthDeductionBreakdown.reduce(function (acc, breakdown) {
            acc.absence += breakdown.absence;
            acc.permission += breakdown.permission;
            acc.tardiness += breakdown.tardiness;
            acc.manual += breakdown.manual;
            return acc;
        }, createDeductionBreakdown());
        return {
            ready: true,
            months: months,
            rows: rows,
            monthTotals: monthTotals,
            monthTotalsPaid: monthTotalsPaid,
            monthTotalsDeductions: monthTotalsDeductions,
            monthDeductionBreakdown: monthDeductionBreakdown,
            totalDeductionBreakdown: totalDeductionBreakdown,
            monthAdvances: monthAdvances,
            monthHolidays: monthHolidays,
            monthBonuses: monthBonuses,
            monthOvertime: monthOvertime,
            total: total,
            totalPaid: totalPaid,
            totalDeductions: totalDeductions,
            totalAdvances: monthAdvances.reduce(function (acc, value) { return acc + value; }, 0),
            totalHolidays: monthHolidays.reduce(function (acc, value) { return acc + value; }, 0),
            totalBonuses: monthBonuses.reduce(function (acc, value) { return acc + value; }, 0),
            totalOvertime: monthOvertime.reduce(function (acc, value) { return acc + value; }, 0),
            areaExtras: areaExtras,
        };
    }, [accumulationPeriods, periodDetailsCache, employeesById]);
    var accumulationRowsForArea = (0, react_1.useMemo)(function () {
        return reportAreaFilter === 'ALL'
            ? accumulationSummary.rows
            : accumulationSummary.rows.filter(function (row) { return row.area === reportAreaFilter; });
    }, [accumulationSummary.rows, reportAreaFilter]);
    var accumulationDisplay = (0, react_1.useMemo)(function () {
        var rows = accumulationRowsForArea;
        var months = accumulationSummary.months;
        var paymentFilter = accumulationPaymentFilter;
        var accountFilter = accumulationAccountFilter;
        var filteredRows = rows.filter(function (row) {
            var _a;
            var paid = (_a = accumulationPayments[row.employeeId]) !== null && _a !== void 0 ? _a : false;
            if (paymentFilter === 'PAID' && !paid)
                return false;
            if (paymentFilter === 'UNPAID' && paid)
                return false;
            var hasAccount = Boolean((row.account && row.account !== '—') ||
                (row.cci && row.cci !== '—') ||
                (row.yapePlin && row.yapePlin !== '—'));
            if (accountFilter === 'WITH' && !hasAccount)
                return false;
            if (accountFilter === 'WITHOUT' && hasAccount)
                return false;
            return true;
        });
        var monthTotals = Array(months.length).fill(0);
        var monthTotalsPaid = Array(months.length).fill(0);
        var monthTotalsDeductions = Array(months.length).fill(0);
        filteredRows.forEach(function (row) {
            row.perMonth.forEach(function (value, index) {
                monthTotals[index] += value;
            });
            row.perMonthPaid.forEach(function (value, index) {
                monthTotalsPaid[index] += value;
            });
            row.perMonthDeductions.forEach(function (value, index) {
                monthTotalsDeductions[index] += value;
            });
        });
        var total = filteredRows.reduce(function (acc, row) { return acc + row.total; }, 0);
        var totalPaid = filteredRows.reduce(function (acc, row) { return acc + row.totalPaid; }, 0);
        var totalDeductions = filteredRows.reduce(function (acc, row) { return acc + row.totalDeductions; }, 0);
        return {
            rows: filteredRows,
            months: months,
            monthTotals: monthTotals,
            monthTotalsPaid: monthTotalsPaid,
            monthTotalsDeductions: monthTotalsDeductions,
            total: total,
            totalPaid: totalPaid,
            totalDeductions: totalDeductions,
        };
    }, [
        accumulationRowsForArea,
        accumulationSummary,
        accumulationAccountFilter,
        accumulationPaymentFilter,
        accumulationPayments,
    ]);
    var filteredAccountsRows = (0, react_1.useMemo)(function () {
        if (bankFilter === 'ALL')
            return accountsRows;
        var predicate = function (row) {
            return bankFilter === 'WITH' ? row.hasAccount : !row.hasAccount;
        };
        return accountsRows.filter(predicate);
    }, [accountsRows, bankFilter]);
    var accumulationAreaBreakdown = (0, react_1.useMemo)(function () {
        var template = function () { return ({
            monthNet: Array(accumulationSummary.months.length).fill(0),
            monthPaid: Array(accumulationSummary.months.length).fill(0),
            monthDeductions: Array(accumulationSummary.months.length).fill(0),
            totalNet: 0,
            totalPaid: 0,
            totalDeductions: 0,
            netPaid: 0,
            netPending: 0,
        }); };
        var map = {
            ALL: template(),
            OPERATIVE: template(),
            ADMINISTRATIVE: template(),
        };
        accumulationSummary.rows.forEach(function (row) {
            var _a;
            var targets = [map.ALL, map[row.area]];
            var isPaid = (_a = accumulationPayments[row.employeeId]) !== null && _a !== void 0 ? _a : false;
            targets.forEach(function (bucket) {
                row.perMonth.forEach(function (value, index) {
                    bucket.monthNet[index] += value;
                });
                row.perMonthPaid.forEach(function (value, index) {
                    bucket.monthPaid[index] += value;
                });
                row.perMonthDeductions.forEach(function (value, index) {
                    bucket.monthDeductions[index] += value;
                });
                bucket.totalNet += row.total;
                bucket.totalPaid += row.totalPaid;
                bucket.totalDeductions += row.totalDeductions;
                if (isPaid)
                    bucket.netPaid += row.total;
                else
                    bucket.netPending += row.total;
            });
        });
        map.ALL.monthNet = accumulationSummary.monthTotals.slice();
        map.ALL.monthPaid = accumulationSummary.monthTotalsPaid.slice();
        map.ALL.monthDeductions = accumulationSummary.monthTotalsDeductions.slice();
        map.ALL.totalNet = accumulationSummary.total;
        map.ALL.totalPaid = accumulationSummary.totalPaid;
        map.ALL.totalDeductions = accumulationSummary.totalDeductions;
        return map;
    }, [accumulationPayments, accumulationSummary]);
    var summaryCardMonths = (0, react_1.useMemo)(function () {
        var rows = accumulationSummary.rows;
        var start = Math.max(accumulationSummary.months.length - DEFAULT_ACCUMULATION_MONTHS, 0);
        return accumulationSummary.months.slice(start).map(function (month, displayIndex) {
            var _a, _b, _c, _d, _e, _f, _g;
            var summaryIndex = start + displayIndex;
            var breakdown = (_a = accumulationSummary.monthDeductionBreakdown[summaryIndex]) !== null && _a !== void 0 ? _a : createDeductionBreakdown();
            var paidMarked = 0;
            rows.forEach(function (row) {
                var _a, _b;
                var value = (_a = row.perMonth[summaryIndex]) !== null && _a !== void 0 ? _a : 0;
                if (!value)
                    return;
                var isPaid = (_b = accumulationPayments[row.employeeId]) !== null && _b !== void 0 ? _b : false;
                if (isPaid)
                    paidMarked += value;
            });
            var net = (_b = accumulationSummary.monthTotals[summaryIndex]) !== null && _b !== void 0 ? _b : 0;
            var advances = (_c = accumulationSummary.monthAdvances[summaryIndex]) !== null && _c !== void 0 ? _c : 0;
            var holidays = (_d = accumulationSummary.monthHolidays[summaryIndex]) !== null && _d !== void 0 ? _d : 0;
            var overtime = (_e = accumulationSummary.monthOvertime[summaryIndex]) !== null && _e !== void 0 ? _e : 0;
            var bonuses = (_f = accumulationSummary.monthBonuses[summaryIndex]) !== null && _f !== void 0 ? _f : 0;
            var extrasTotal = advances + holidays + overtime + bonuses;
            var disbursed = paidMarked + extrasTotal;
            var pendingNet = Math.max(net - paidMarked, 0);
            var totalToPay = disbursed + pendingNet;
            return {
                id: month.id,
                label: month.label,
                net: net,
                disbursed: disbursed,
                pending: pendingNet,
                totalToPay: totalToPay,
                extrasTotal: extrasTotal,
                deductions: (_g = accumulationSummary.monthTotalsDeductions[summaryIndex]) !== null && _g !== void 0 ? _g : 0,
                breakdown: breakdown,
                breakdownLabel: formatDeductionBreakdown(breakdown),
                paidMarked: paidMarked,
                advances: advances,
                holidays: holidays,
                overtime: overtime,
                bonuses: bonuses,
            };
        });
    }, [accumulationPayments, accumulationSummary]);
    var summaryCardAreas = (0, react_1.useMemo)(function () {
        return __spreadArray(['ALL'], EMPLOYEE_AREA_VALUES, true).map(function (bucket) { return ({
            key: bucket,
            label: bucket === 'ALL' ? 'Resumen general' : EMPLOYEE_AREA_LABELS[bucket],
            data: accumulationAreaBreakdown[bucket],
            extras: accumulationSummary.areaExtras[bucket],
        }); });
    }, [accumulationAreaBreakdown, accumulationSummary.areaExtras]);
    var accumulationPaymentStats = (0, react_1.useMemo)(function () {
        return accumulationSummary.rows.reduce(function (acc, row) {
            var _a;
            var isPaid = (_a = accumulationPayments[row.employeeId]) !== null && _a !== void 0 ? _a : false;
            var totalPaid = row.totalPaid;
            if (isPaid) {
                acc.paid += totalPaid;
                acc.paidCount += 1;
            }
            else {
                acc.pending += totalPaid;
                acc.pendingCount += 1;
            }
            return acc;
        }, { paid: 0, pending: 0, paidCount: 0, pendingCount: 0 });
    }, [accumulationPayments, accumulationSummary.rows]);
    var accumulationDisbursement = (0, react_1.useMemo)(function () {
        var extras = {
            advances: accumulationSummary.totalAdvances,
            holidays: accumulationSummary.totalHolidays,
            overtime: accumulationSummary.totalOvertime,
            bonuses: accumulationSummary.totalBonuses,
        };
        var extrasTotal = extras.advances + extras.holidays + extras.overtime + extras.bonuses;
        var totalDisbursed = Math.max(accumulationPaymentStats.paid, 0);
        var pending = Math.max(accumulationPaymentStats.pending, 0);
        return {
            extras: extras,
            extrasTotal: extrasTotal,
            totalDisbursed: totalDisbursed,
            pending: pending,
            totalToPay: totalDisbursed + pending,
        };
    }, [
        accumulationPaymentStats,
        accumulationSummary.totalAdvances,
        accumulationSummary.totalHolidays,
        accumulationSummary.totalOvertime,
        accumulationSummary.totalBonuses,
    ]);
    var handlePrintAreaReport = (0, react_1.useCallback)(function () {
        if (!periodDetails) {
            setEntryAlert('Selecciona un periodo para imprimir.');
            return;
        }
        if (!areaReportRows.length) {
            setEntryAlert('No hay colaboradores en esta área para este periodo.');
            return;
        }
        var areaLabel = reportAreaFilter === 'ALL'
            ? 'Todas las áreas'
            : EMPLOYEE_AREA_LABELS[reportAreaFilter];
        var monthLabel = "".concat(MONTH_NAMES[periodDetails.month - 1], " ").concat(periodDetails.year);
        var rowsHtml = areaReportRows
            .map(function (_a) {
            var _b, _c;
            var entry = _a.entry, summary = _a.summary;
            var worker = escapeHtml(employeeName(entry.employee));
            var daysLine = escapeHtml(summary.daysDisplay);
            var ingreso = summary.startDate ? "<div class=\"muted\">Ingreso: ".concat(escapeHtml(formatIsoDate(summary.startDate)), "</div>") : '';
            var workCell = "".concat(summary.workedDays, " / ").concat(summary.absenceDays);
            var tardyCell = "".concat(summary.tardinessMinutes, " min \u00B7 Permisos: ").concat(summary.permissionDaysRecorded, "d (").concat(escapeHtml(fixed2(summary.permissionHours)), " h)");
            var feriadosCell = "".concat(summary.holidayDays, " d\u00EDas \u00B7 ").concat(currency(summary.holidayBonus));
            var deductions = currency(summary.actualDeductions);
            var bonuses = currency((_b = entry.bonusesTotal) !== null && _b !== void 0 ? _b : 0);
            var neto = currency((_c = entry.netPay) !== null && _c !== void 0 ? _c : 0);
            return "\n  <tr>\n    <td>".concat(worker, "</td>\n    <td>").concat(currency(summary.monthlyBase), "</td>\n    <td>").concat(currency(summary.proratedBase), "</td>\n    <td>").concat(daysLine).concat(ingreso, "</td>\n    <td>").concat(workCell, "</td>\n    <td>").concat(tardyCell, "</td>\n    <td>").concat(feriadosCell, "</td>\n    <td>").concat(deductions, "</td>\n    <td>").concat(bonuses, "</td>\n    <td>").concat(neto, "</td>\n  </tr>");
        })
            .join('');
        var totalsRow = "\n  <tr class=\"totals-row\">\n    <td colspan=\"9\">Total neto del \u00E1rea</td>\n    <td>".concat(currency(areaReportNetTotal), "</td>\n  </tr>");
        var reportSection = "\n<section class=\"area-report\">\n  <h2>Reporte ".concat(escapeHtml(areaLabel), " \u00B7 ").concat(escapeHtml(monthLabel), "</h2>\n  <table>\n    <thead>\n      <tr>\n        <th>Trabajador</th>\n        <th>Sueldo mensual</th>\n        <th>Prorrateado</th>\n        <th>D\u00EDas remunerados</th>\n        <th>Asistencias / Faltas</th>\n        <th>Tardanzas / Permisos</th>\n        <th>Feriados</th>\n        <th>Descuentos</th>\n        <th>Ajustes</th>\n        <th>Sueldo neto</th>\n      </tr>\n    </thead>\n    <tbody>\n      ").concat(rowsHtml, "\n    </tbody>\n    <tfoot>\n      ").concat(totalsRow, "\n    </tfoot>\n  </table>\n</section>");
        var title = "Planillas".concat(MONTH_NAMES[periodDetails.month - 1]).concat(areaLabel.replace(/\\s+/g, '')).concat(periodDetails.year);
        var html = renderPrintDocument([reportSection], title);
        openPrintDocument(html);
    }, [areaReportNetTotal, areaReportRows, periodDetails, reportAreaFilter, renderPrintDocument]);
    var handlePrintBankReport = (0, react_1.useCallback)(function () {
        if (!periodDetails) {
            setEntryAlert('Selecciona un periodo para imprimir las cuentas.');
            return;
        }
        if (!filteredAccountsRows.length) {
            setEntryAlert('No hay registros que coincidan con el filtro seleccionado.');
            return;
        }
        var monthLabel = "".concat(MONTH_NAMES[periodDetails.month - 1], " ").concat(periodDetails.year);
        var rowsHtml = filteredAccountsRows
            .map(function (row) {
            var worker = escapeHtml(row.worker);
            var bank = escapeHtml(row.bank);
            var account = escapeHtml(row.account);
            var cci = escapeHtml(row.cci);
            var yapePlin = escapeHtml(row.yapePlin);
            return "\n  <tr>\n    <td>".concat(worker, "</td>\n    <td>").concat(bank, "</td>\n    <td>").concat(account, "</td>\n    <td>").concat(cci, "</td>\n    <td>").concat(yapePlin, "</td>\n  </tr>");
        })
            .join('');
        var reportSection = "\n<section class=\"area-report\">\n  <h2>Relaci\u00F3n de cuentas \u00B7 ".concat(escapeHtml(monthLabel), "</h2>\n  <table>\n    <thead>\n      <tr>\n        <th>Trabajador</th>\n        <th>Banco</th>\n        <th>N\u00FAmero de cuenta</th>\n        <th>CCI</th>\n        <th>Yape/Plin</th>\n      </tr>\n    </thead>\n    <tbody>\n      ").concat(rowsHtml, "\n    </tbody>\n  </table>\n</section>");
        var titleSuffix = bankFilter === 'WITH' ? 'ConCuenta' : bankFilter === 'WITHOUT' ? 'SinCuenta' : 'Todas';
        var html = renderPrintDocument([reportSection], "Cuentas".concat(titleSuffix).concat(monthLabel.replace(/\\s+/g, '')));
        openPrintDocument(html);
    }, [bankFilter, filteredAccountsRows, openPrintDocument, periodDetails, renderPrintDocument]);
    var handlePrintAccumulationReport = (0, react_1.useCallback)(function () {
        if (!accumulationSummary.months.length) {
            setEntryAlert('Selecciona al menos un periodo para imprimir el acumulado.');
            return;
        }
        if (!accumulationSummary.ready) {
            setEntryAlert('Espera a que termine el cálculo del acumulado.');
            return;
        }
        if (!accumulationDisplay.rows.length) {
            setEntryAlert('No hay información acumulada para los filtros seleccionados.');
            return;
        }
        var areaLabel = reportAreaFilter === 'ALL'
            ? 'Todas las áreas'
            : EMPLOYEE_AREA_LABELS[reportAreaFilter];
        var monthHeaders = accumulationSummary.months
            .map(function (month) { return "<th>".concat(escapeHtml(month.label), "</th>"); })
            .join('');
        var rowsHtml = accumulationDisplay.rows
            .map(function (row) {
            var worker = escapeHtml(employeeName(row.employee));
            var account = escapeHtml(row.account || '—');
            var cci = escapeHtml(row.cci || '—');
            var yapePlin = escapeHtml(row.yapePlin || '—');
            var bank = escapeHtml(row.bank || '—');
            var monthCells = accumulationSummary.months
                .map(function (_month, index) {
                var _a, _b;
                var netValue = (_a = row.perMonth[index]) !== null && _a !== void 0 ? _a : 0;
                var paidValue = (_b = row.perMonthPaid[index]) !== null && _b !== void 0 ? _b : netValue;
                return "<td><div>".concat(currency(netValue), "</div><div class=\"muted\">Pagado: ").concat(currency(paidValue), "</div></td>");
            })
                .join('');
            return "\n  <tr>\n    <td>".concat(worker, "</td>\n    ").concat(monthCells, "\n    <td>").concat(currency(row.total), "</td>\n    <td>").concat(currency(row.totalPaid), "</td>\n    <td>").concat(currency(row.totalDeductions), "</td>\n    <td>").concat(bank, "</td>\n    <td>").concat(account, "</td>\n    <td>").concat(cci, "</td>\n    <td>").concat(yapePlin, "</td>\n    <td>").concat(accumulationPayments[row.employeeId] ? 'Pagado' : 'Pendiente', "</td>\n  </tr>");
        })
            .join('');
        var totalsCells = accumulationDisplay.monthTotals
            .map(function (total, index) {
            var _a, _b;
            var paidValue = (_a = accumulationDisplay.monthTotalsPaid[index]) !== null && _a !== void 0 ? _a : total;
            var deductionValue = (_b = accumulationDisplay.monthTotalsDeductions[index]) !== null && _b !== void 0 ? _b : 0;
            return "<td><div>".concat(currency(total), "</div><div class=\"muted\">Pagado: ").concat(currency(paidValue), "</div><div class=\"muted\">Desc.: ").concat(currency(deductionValue), "</div></td>");
        })
            .join('');
        var reportSection = "\n<section class=\"area-report\">\n  <h2>Acumulado hist\u00F3rico \u00B7 ".concat(escapeHtml(areaLabel), "</h2>\n  <p>Periodos: ").concat(escapeHtml(accumulationSummary.months.map(function (month) { return month.label; }).join(', ')), "</p>\n  <p class=\"muted\">Cada celda muestra el neto del mes y debajo el total pagado (neto + adelantos).</p>\n  <table>\n    <thead>\n      <tr>\n        <th>Trabajador</th>\n        ").concat(monthHeaders, "\n        <th>Acumulado</th>\n        <th>Pagado total</th>\n        <th>Descuentos</th>\n        <th>Banco</th>\n        <th>Cuenta bancaria</th>\n        <th>CCI</th>\n        <th>Yape/Plin</th>\n        <th>Estado</th>\n      </tr>\n    </thead>\n    <tbody>\n      ").concat(rowsHtml, "\n    </tbody>\n    <tfoot>\n      <tr>\n        <td>Subtotal ").concat(escapeHtml(areaLabel), "</td>\n        ").concat(totalsCells, "\n        <td>").concat(currency(accumulationDisplay.total), "</td>\n        <td>").concat(currency(accumulationDisplay.totalPaid), "</td>\n        <td>").concat(currency(accumulationDisplay.totalDeductions), "</td>\n        <td>\u2014</td>\n        <td>\u2014</td>\n        <td>\u2014</td>\n        <td>\u2014</td>\n        <td>\u2014</td>\n      </tr>\n    </tfoot>\n  </table>\n</section>");
        var title = "Acumulado".concat(areaLabel.replace(/\s+/g, '')).concat(accumulationSummary.months
            .map(function (month) { return month.label.replace(/\s+/g, ''); })
            .join(''));
        var html = renderPrintDocument([reportSection], title || 'Acumulado', { orientation: 'landscape' });
        openPrintDocument(html);
    }, [accumulationDisplay, accumulationSummary, accumulationPayments, openPrintDocument, reportAreaFilter, renderPrintDocument]);
    var chosenEntryAttendance = chosenEntrySummary === null || chosenEntrySummary === void 0 ? void 0 : chosenEntrySummary.attendance;
    var attendancePenaltyDays = (chosenEntryAttendance === null || chosenEntryAttendance === void 0 ? void 0 : chosenEntryAttendance.absencePenaltyDays) && chosenEntryAttendance.absencePenaltyDays > 0
        ? chosenEntryAttendance.absencePenaltyDays
        : 0;
    var recordedAbsenceDays = (_d = (_c = (_b = chosenEntryAttendance === null || chosenEntryAttendance === void 0 ? void 0 : chosenEntryAttendance.recordedAbsenceDays) !== null && _b !== void 0 ? _b : chosenEntryAttendance === null || chosenEntryAttendance === void 0 ? void 0 : chosenEntryAttendance.absenceDays) !== null && _c !== void 0 ? _c : chosenEntry === null || chosenEntry === void 0 ? void 0 : chosenEntry.absenceDays) !== null && _d !== void 0 ? _d : 0;
    var attendanceFilterEmployee = (0, react_1.useMemo)(function () {
        var _a;
        return typeof attendanceEmployeeFilter === 'number'
            ? (_a = employees.find(function (employee) { return employee.id === attendanceEmployeeFilter; })) !== null && _a !== void 0 ? _a : null
            : null;
    }, [attendanceEmployeeFilter, employees]);
    return ((0, jsx_runtime_1.jsx)("div", { children: "stub" }));
}
